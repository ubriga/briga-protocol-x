<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Protocol X: v3.1 Secure</title>
    <script src="https://cdn.jsdelivr.net/npm/disable-devtool@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        /* ... (转 CSS  拽) ... */
        :root { --main: #00f0ff; --warn: #ff0055; --bg: #050505; --panel: rgba(10,15,20,0.95); }
        body { margin: 0; overflow: hidden; background: var(--bg); color: #fff; font-family: 'Rajdhani', sans-serif; user-select: none; }
        
        #gameCanvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }
        .screen { position: absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; background: var(--bg); z-index:10; transition:0.3s; }
        .hidden { display: none !important; }
        .overlay { background: rgba(0,0,0,0.9); z-index: 20; }
        
        /* UI Components */
        .box { background: var(--panel); border: 1px solid var(--main); padding: 30px; border-radius: 5px; text-align: center; }
        input { background: #111; border: 1px solid #444; color: white; padding: 10px; width: 200px; margin: 5px; text-align: center; }
        button { background: transparent; border: 1px solid var(--main); color: var(--main); padding: 8px 20px; cursor: pointer; margin: 5px; font-weight: bold; }
        button:hover { background: var(--main); color: black; }
        button.danger { border-color: var(--warn); color: var(--warn); }
        button.danger:hover { background: var(--warn); color: white; }
        
        /* HUD */
        #game-ui { position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 5; }
        .hud-el { position: absolute; pointer-events: auto; }
        
        /* Admin Table */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
        th, td { border: 1px solid #333; padding: 5px; text-align: left; }
        th { color: gold; }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="toast" style="position:fixed; top:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); padding:10px 30px; border:1px solid white; z-index:999; opacity:0; pointer-events:none; transition:0.3s;">MSG</div>

    <canvas id="gameCanvas"></canvas>

    <!-- HUD -->
    <div id="game-ui" class="hidden">
        <div class="hud-el" style="top:20px; left:20px;">
            <button onclick="app.toLobby()">ABORT MISSION</button>
            <div style="margin-top:10px; color:var(--main);">WAVE: <span id="g-wave">1</span></div>
            <div style="color:var(--warn);">HP: <span id="g-hp">100</span>%</div>
        </div>
        <div class="hud-el" style="top:20px; right:20px; font-size:24px;">
            <span id="g-score">0</span> PTS
        </div>
        <!-- Drone Button -->
        <div class="hud-el" style="bottom:20px; left:50%; transform:translateX(-50%); text-align:center;">
            <button id="btn-drone" onclick="game.useDrone()" style="width:60px; height:60px; border-radius:50%; font-size:24px;"></button>
            <div style="font-size:10px;">DRONES: <span id="drone-qty">0</span></div>
        </div>
    </div>

    <!-- SCREENS -->
    <div id="screen-login" class="screen">
        <h1>PROTOCOL X</h1>
        <div class="box">
            <input type="text" id="inp-u" placeholder="PILOT ID"><br>
            <input type="password" id="inp-p" placeholder="ACCESS CODE"><br>
            <button onclick="auth.login()">LOGIN</button>
            <button onclick="auth.register()" style="border-color:gold; color:gold;">REGISTER</button>
        </div>
        <div style="margin-top:20px; font-size:12px; color:#666;">v3.1 SECURE</div>
    </div>

    <div id="screen-lobby" class="screen hidden">
        <div style="position:absolute; top:20px; right:20px; text-align:right;">
            <div>CMD. <span id="l-user">Guest</span></div>
            <div style="color:gold;"> <span id="l-credits">0</span></div>
            <button onclick="auth.logout()" style="font-size:10px; border:none;">LOGOUT</button>
        </div>
        
        <h1>COMMAND DECK</h1>
        <div style="display:flex; gap:20px;">
            <div class="box">
                <h3>OPERATIONS</h3>
                <button onclick="game.start()" style="width:100%; padding:20px; font-size:20px;">LAUNCH MISSION</button>
                <button onclick="app.redeem()" style="width:100%; margin-top:10px;">REDEEM CODE</button>
                <div id="admin-area" style="margin-top:20px;"></div>
            </div>
            <div class="box">
                <h3>ARMORY</h3>
                <div>
                    <span> DRONE SUPPORT</span><br>
                    <small>Auto-fire 10s</small><br>
                    <button onclick="shop.buy('consumable','drone_support',500)">BUY (500)</button>
                    <div>OWNED: <span id="l-drone">0</span></div>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-admin" class="screen overlay hidden">
        <div class="box" style="width:80%; height:80%; overflow:auto;">
            <div style="display:flex; justify-content:space-between;">
                <h2>SECURE CONSOLE</h2>
                <button onclick="app.toLobby()">CLOSE</button>
            </div>
            
            <div style="margin:20px 0; border-bottom:1px solid #333;">
                <button onclick="admin.load()">REFRESH</button>
                <button onclick="admin.createCoupon()">NEW COUPON</button>
            </div>

            <table id="adm-table">
                <thead><tr><th>ID</th><th>USER</th><th>STATUS</th><th>ACTIONS</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

<script>
const API = "https://ubriga.pythonanywhere.com";
const ADMIN_PIN = "1201847"; // Client-side check for UI
let USER = null, TOKEN = localStorage.getItem('px_token');

const toast = (m) => { const t=document.getElementById('toast'); t.innerText=m; t.style.opacity=1; setTimeout(()=>t.style.opacity=0,3000); };

const app = {
    init: () => {
        if(TOKEN) auth.validate();
        else app.show('screen-login');
    },
    show: (id) => {
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById('game-ui').classList.add('hidden');
        document.getElementById(id).classList.remove('hidden');
    },
    toLobby: () => {
        game.stop();
        app.show('screen-lobby');
        app.updateUI();
    },
    updateUI: () => {
        document.getElementById('l-user').innerText = USER.username;
        document.getElementById('l-credits').innerText = USER.credits;
        document.getElementById('l-drone').innerText = (USER.consumables && USER.consumables['drone_support']) || 0;
        
        const admDiv = document.getElementById('admin-area');
        admDiv.innerHTML = '';
        if(USER.is_admin) {
            const btn = document.createElement('button');
            btn.innerText = "ADMIN CONSOLE";
            btn.style.borderColor = "gold";
            btn.style.color = "gold";
            btn.onclick = () => {
                const p = prompt("ENTER SECURE PIN:");
                if(p === ADMIN_PIN) {
                    admin.load();
                    app.show('screen-admin');
                } else {
                    toast("ACCESS DENIED");
                }
            };
            admDiv.appendChild(btn);
        }
    },
    redeem: async () => {
        const c = prompt("Code:");
        if(!c) return;
        // ... (拽 redeem 专, 转 砖专 砖  转)
    }
};

const auth = {
    login: async () => {
        const u = document.getElementById('inp-u').value;
        const p = document.getElementById('inp-p').value;
        try {
            const res = await fetch(`${API}/login`, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({username:u, password:p})
            });
            const d = await res.json();
            if(d.error) return toast(d.error);
            TOKEN = d.token; USER = d.user;
            localStorage.setItem('px_token', TOKEN);
            app.toLobby();
        } catch(e) { toast("Connection Failed"); }
    },
    register: async () => {
        const u = document.getElementById('inp-u').value;
        const p = document.getElementById('inp-p').value;
        try {
            const res = await fetch(`${API}/register`, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({username:u, password:p})
            });
            const d = await res.json();
            toast(d.message || d.error);
        } catch(e) { toast("Error"); }
    },
    validate: () => app.show('screen-login'), // Force re-login
    logout: () => { localStorage.removeItem('px_token'); location.reload(); }
};

const shop = {
    buy: async (type, id, cost) => {
        if(USER.credits < cost) return toast("No Funds");
        // ... (拽 拽 专住 拽转)
        // Dummy update for visual
        USER.credits -= cost;
        if(!USER.consumables) USER.consumables = {};
        USER.consumables[id] = (USER.consumables[id]||0)+1;
        app.updateUI();
        toast("Purchased!");
    }
};

const admin = {
    load: async () => {
        try {
            const res = await fetch(`${API}/admin/dashboard`, {headers:{'Authorization':`Bearer ${TOKEN}`}});
            const d = await res.json();
            if(d.error) return toast(d.error);
            
            const tbody = document.querySelector('#adm-table tbody');
            tbody.innerHTML = d.users.map(u => `
                <tr>
                    <td>${u.id}</td>
                    <td>${u.username} ${u.admin?'[A]':''}</td>
                    <td style="color:${u.approved ? '#0f0':'#f00'}">${u.approved ? 'ACTIVE' : 'PENDING'}</td>
                    <td>
                        ${!u.approved ? `<button onclick="admin.approve(${u.id})">APPROVE</button>` : ''}
                        <button class="danger" onclick="admin.ban(${u.id})">BAN</button>
                    </td>
                </tr>
            `).join('');
        } catch(e) { toast("Load Error"); }
    },
    approve: async (uid) => {
        await fetch(`${API}/admin/action`, {
            method:'POST', headers:{'Content-Type':'application/json', 'Authorization':`Bearer ${TOKEN}`},
            body:JSON.stringify({action:'approve_user', user_id:uid})
        });
        admin.load();
    },
    createCoupon: () => {
        const c = prompt("Code:"); const v = prompt("Value:");
        if(c && v) {
            // Call API...
            toast("Coupon Created (Simulated)");
        }
    }
};

// GAME ENGINE FIX
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let g = { run: false, score: 0 };
let player = {x:0, y:0};

const game = {
    start: () => {
        canvas.width = window.innerWidth; // FIX BLACK SCREEN
        canvas.height = window.innerHeight;
        g = { run: true, score: 0, wave: 1, hp: 100, frames: 0 };
        player = { x: canvas.width/2, y: canvas.height/2 };
        
        app.show(''); 
        document.getElementById('game-ui').classList.remove('hidden');
        
        // Update HUD
        const dCount = (USER.consumables && USER.consumables['drone_support']) || 0;
        document.getElementById('drone-qty').innerText = dCount;
        
        loop();
    },
    stop: () => { g.run = false; },
    useDrone: () => {
        if(USER.consumables['drone_support'] > 0) {
            USER.consumables['drone_support']--;
            document.getElementById('drone-qty').innerText = USER.consumables['drone_support'];
            toast("DRONE ACTIVE!");
        } else toast("No Drones!");
    }
};

function loop() {
    if(!g.run) return;
    
    // Simple Render
    ctx.fillStyle = '#050505'; ctx.fillRect(0,0,canvas.width,canvas.height);
    
    // Player
    canvas.onmousemove = e => { player.x = e.clientX; player.y = e.clientY; };
    ctx.fillStyle = '#0ff'; ctx.beginPath(); ctx.arc(player.x, player.y, 10, 0, Math.PI*2); ctx.fill();
    
    // Text
    ctx.fillStyle = '#fff'; ctx.fillText("GAME ACTIVE - CLICK ABORT TO EXIT", 20, 100);
    
    requestAnimationFrame(loop);
}

window.onload = app.init;
window.onresize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
</script>
</body>
</html>
