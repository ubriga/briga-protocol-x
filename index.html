<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BRIGAGAME v7.3 | RESCUE</title>
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <style>
        :root { --main: #00ffcc; --bg: #1a0b2e; --panel: rgba(20, 10, 40, 0.95); --danger: #ff3366; --font: sans-serif; }
        body { margin:0; overflow:hidden; background:var(--bg); color:var(--main); font-family:var(--font); touch-action:none; width:100vw; height:100dvh; }
        canvas { display:block; width:100%; height:100%; }
        #ui-layer { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; }
        
        /* HUD */
        #hud { display:none; }
        .bar-container { width:100px; height:8px; background:#222; border:1px solid #555; margin-top:4px; }
        .bar-fill { height:100%; width:100%; transition: width 0.2s; }
        .hp-fill { background: linear-gradient(90deg, #ff3366, #ff0000); }
        .heat-fill { background: linear-gradient(90deg, #ffcc00, #ffff00); }
        
        /* SCREENS */
        .screen { pointer-events:auto; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:none; flex-direction:column; align-items:center; justify-content:center; z-index:100; }
        .box { background:var(--panel); border:1px solid var(--main); padding:20px; width:90%; max-width:400px; text-align:center; border-radius:8px; position:relative; max-height:90vh; overflow-y:auto; }
        input, button, select { font-size:16px; padding:10px; width:100%; margin:5px 0; box-sizing:border-box; }
        input { background:#000; border:1px solid #555; color:#fff; text-align:center; }
        button { background:var(--main); border:none; color:#000; font-weight:bold; cursor:pointer; }
        .tab-btn { background:transparent; border:1px solid #555; color:#aaa; width:auto; flex:1; }
        .tab-btn.active { background:var(--main); color:#000; }
        
        /* ADMIN SPECIFIC */
        .adm-user-row { display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; padding:5px; font-size:11px; text-align:left; }
        .adm-btn { width:auto; padding:2px 5px; font-size:10px; margin:0 2px; }
        .banned { color:red; text-decoration:line-through; }
        
        /* MOBILE JOYSTICK */
        #mobile-controls { display:none; position:absolute; inset:0; pointer-events:auto; z-index:50; }
        #joy-base { position:absolute; width:100px; height:100px; border:2px solid rgba(255,255,255,0.2); border-radius:50%; transform:translate(-50%,-50%); display:none; }
        #joy-stick { position:absolute; top:50%; left:50%; width:40px; height:40px; background:rgba(0,255,204,0.5); border-radius:50%; transform:translate(-50%,-50%); }
        #btn-fire { position:absolute; bottom:50px; right:30px; width:80px; height:80px; background:rgba(255,0,0,0.2); border:2px solid var(--danger); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:24px; }
        
        #toast { position:fixed; bottom:100px; left:50%; transform:translateX(-50%); background:#000; padding:10px; border:1px solid var(--main); opacity:0; pointer-events:none; transition:0.3s; }
    </style>
</head>
<body>

<canvas id="gameCanvas"></canvas>

<!-- MOBILE -->
<div id="mobile-controls">
    <div id="zone-move" style="position:absolute; width:50%; height:100%;"></div>
    <div id="joy-base"><div id="joy-stick"></div></div>
    <div id="btn-fire">üî•</div>
</div>

<div id="ui-layer">
    <div id="toast">MSG</div>
    
    <!-- HUD (FIXED: Added Heat Bar back) -->
    <div id="hud">
        <div style="position:absolute; top:10px; left:10px;">
            <div style="font-size:10px;">HULL INTEGRITY</div>
            <div class="bar-container"><div class="bar-fill hp-fill" id="bar-hp"></div></div>
        </div>
        <div style="position:absolute; top:10px; right:10px; text-align:right;">
            <div style="font-size:10px;">WEAPON HEAT</div>
            <div class="bar-container"><div class="bar-fill heat-fill" id="bar-heat"></div></div>
            <div id="score-disp" style="font-size:20px; font-weight:bold; margin-top:5px;">0</div>
        </div>
        <div style="position:absolute; top:0; left:40%; width:20%; height:50px; pointer-events:auto;" onclick="game.togglePause()"></div>
    </div>

    <!-- LOGIN -->
    <div id="screen-login" class="screen" style="display:flex;">
        <div class="box">
            <h1>BRIGA PROTOCOL</h1>
            <input id="u" placeholder="PILOT NAME">
            <input id="p" type="password" placeholder="ACCESS CODE">
            <button onclick="auth.login()">LOGIN</button>
            <button onclick="auth.reg()" style="background:transparent; color:#fff; border:1px solid #555;">REGISTER</button>
        </div>
    </div>

    <!-- LOBBY -->
    <div id="screen-lobby" class="screen">
        <div class="box">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span id="u-name" style="font-weight:bold;">PILOT</span>
                <span id="u-creds" style="color:gold;">0</span>
            </div>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <button onclick="ui.tab('ops')" class="tab-btn active">PLAY</button>
                <button onclick="ui.tab('shop')" class="tab-btn">SHOP</button>
                <button onclick="ui.tab('admin')" id="btn-adm" class="tab-btn" style="display:none;">ADM</button>
            </div>
            
            <!-- OPS -->
            <div id="tab-ops">
                <select id="mode-sel">
                    <option value="Classic">üêî SPACE FARM</option>
                    <option value="Meteor">‚òÑÔ∏è METEOR STORM</option>
                </select>
                <select id="diff-sel">
                    <option value="Soldier">EASY</option>
                    <option value="Veteran">HARD</option>
                    <option value="Elite">INSANE</option>
                </select>
                <input id="coupon-code" placeholder="ENTER COUPON CODE" style="margin-top:20px;">
                <button onclick="auth.redeem()" style="background:#555; color:#fff;">REDEEM CODE</button>
                <button onclick="app.start()" style="margin-top:20px; font-size:20px;">LAUNCH MISSION</button>
            </div>
            
            <!-- ADMIN -->
            <div id="tab-admin" style="display:none;">
                <div id="adm-lock">
                    <input type="password" id="adm-pin" placeholder="PIN">
                    <button onclick="admin.unlock()">UNLOCK</button>
                </div>
                <div id="adm-panel" style="display:none;">
                    <button onclick="admin.refresh()" style="font-size:12px; margin-bottom:5px;">REFRESH LIST</button>
                    
                    <div style="border:1px solid #444; padding:5px; margin-bottom:10px;">
                        <div style="font-size:10px; color:#aaa;">GENERATE COUPON</div>
                        <input id="new-coup-code" placeholder="Code (e.g. BONUS100)" style="font-size:12px;">
                        <input id="new-coup-val" placeholder="Value" type="number" style="font-size:12px;">
                        <button onclick="admin.mkCoupon()" style="font-size:12px;">CREATE</button>
                    </div>

                    <div id="adm-users" style="max-height:150px; overflow-y:auto; background:rgba(0,0,0,0.3);"></div>
                </div>
            </div>

            <button onclick="location.reload()" style="background:#333; color:#fff; margin-top:20px;">LOGOUT</button>
        </div>
    </div>
    
    <!-- OVER -->
    <div id="screen-over" class="screen">
        <div class="box">
            <h1 style="color:red;">GAME OVER</h1>
            <h2 id="final-score">0</h2>
            <button onclick="app.start()">RETRY</button>
            <button onclick="app.lobby()">LOBBY</button>
        </div>
    </div>
</div>

<script>
/** BRIGA v7.3 RESCUE **/
const API="https://ubriga.pythonanywhere.com";
let USER=null, TOKEN=localStorage.getItem('px_t'), KEYS={};

// AUTH
const auth={
    login:async()=>{
        try{
            let res=await fetch(API+'/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:v('u'),password:v('p')})});
            let d=await res.json();
            if(d.token){ USER=d.user; TOKEN=d.token; localStorage.setItem('px_t',TOKEN); app.lobby(); }
            else toast(d.error);
        }catch(e){toast("Err");}
    },
    reg:async()=>{
        await fetch(API+'/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:v('u'),password:v('p')})});
        toast("Registered. Login now.");
    },
    redeem:async()=>{
        let c=v('coupon-code'); if(!c) return;
        let res=await fetch(API+'/redeem',{method:'POST',headers:{'Authorization':`Bearer ${TOKEN}`,'Content-Type':'application/json'},body:JSON.stringify({code:c})});
        let d=await res.json();
        if(d.status==='success'){ toast(`+${d.value} CREDITS`); USER.credits+=d.value; app.ui(); }
        else toast("Invalid Code");
    }
};

// ADMIN
const admin={
    unlock:async()=>{
        let p=v('adm-pin');
        let res=await fetch(API+'/admin/verify_pin',{method:'POST',headers:{'Authorization':`Bearer ${TOKEN}`,'Content-Type':'application/json'},body:JSON.stringify({pin:p})});
        if((await res.json()).status==='success'){
            document.getElementById('adm-lock').style.display='none';
            document.getElementById('adm-panel').style.display='block';
            admin.refresh();
        } else toast("Bad PIN");
    },
    refresh:async()=>{
        let res=await fetch(API+'/admin/dashboard',{headers:{'Authorization':`Bearer ${TOKEN}`}});
        let d=await res.json();
        let h="";
        d.users.forEach(u=>{
            let cls = u.is_banned ? 'banned' : '';
            h+=`<div class="adm-user-row">
                <span class="${cls}">${u.username} (${u.credits})</span>
                <div>
                    <button class="adm-btn" onclick="admin.act('ban',${u.id})" style="background:red">BAN</button>
                    <button class="adm-btn" onclick="admin.act('unban',${u.id})" style="background:lime">UN</button>
                    <button class="adm-btn" onclick="admin.act('reset_name',${u.id})" style="background:orange">RN</button>
                    <button class="adm-btn" onclick="admin.act('add_credits',${u.id})" style="background:gold">$$</button>
                </div>
            </div>`;
        });
        document.getElementById('adm-users').innerHTML=h;
    },
    act:async(a,tid)=>{
        let extra={};
        if(a==='add_credits') extra.amount = prompt("Amount?");
        await fetch(API+'/admin/action',{method:'POST',headers:{'Authorization':`Bearer ${TOKEN}`,'Content-Type':'application/json'},body:JSON.stringify({action:a,target_id:tid,...extra})});
        admin.refresh();
    },
    mkCoupon:async()=>{
        let c=v('new-coup-code'), val=v('new-coup-val');
        await fetch(API+'/admin/action',{method:'POST',headers:{'Authorization':`Bearer ${TOKEN}`,'Content-Type':'application/json'},body:JSON.stringify({action:'create_coupon',code:c,value:val,max:100})});
        toast("Coupon Created");
    }
};

const app={
    cvs:document.getElementById('gameCanvas'),
    ctx:document.getElementById('gameCanvas').getContext('2d'),
    lobby:()=>{
        document.querySelectorAll('.screen').forEach(s=>s.style.display='none');
        document.getElementById('screen-lobby').style.display='flex';
        app.ui();
    },
    start:()=>{
        document.querySelectorAll('.screen').forEach(s=>s.style.display='none');
        document.getElementById('hud').style.display='block';
        game.start();
    },
    ui:()=>{
        document.getElementById('u-name').innerText=USER.display_name||USER.username;
        document.getElementById('u-creds').innerText=USER.credits;
        document.getElementById('btn-adm').style.display=USER.is_admin?'block':'none';
    }
};

const ui={
    tab:(t)=>{
        document.querySelectorAll('[id^="tab-"]').forEach(e=>e.style.display='none');
        document.getElementById('tab-'+t).style.display='block';
    }
};

const game={
    run:false, paused:false,
    p:{x:0,y:0,hp:100,max:100,heat:0},
    objs:[], wave:0, mode:'Classic',
    
    start:()=>{
        game.run=true; game.wave=0; game.p.hp=100; game.p.heat=0; game.objs=[];
        game.p.x=app.cvs.width/2; game.p.y=app.cvs.height-100;
        game.mode=v('mode-sel');
        game.nextWave(); animate();
    },
    nextWave:()=>{
        game.wave++;
        let cnt=5+game.wave;
        for(let i=0;i<cnt;i++) game.objs.push({type:'en', x:Math.random()*app.cvs.width, y:-Math.random()*500, hp:10+game.wave, w:30});
        toast("WAVE "+game.wave);
    },
    togglePause:()=>{ game.paused=!game.paused; },
    end:()=>{
        game.run=false; 
        document.getElementById('screen-over').style.display='flex';
        fetch(API+'/submit_score',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({player:USER.username,score:USER.credits,wave:game.wave,mode:game.mode})});
    }
};

// INPUT & LOOP
function animate(){
    if(!game.run) return;
    requestAnimationFrame(animate);
    if(game.paused) return;

    let ctx=app.ctx, cvs=app.cvs;
    cvs.width=window.innerWidth; cvs.height=window.innerHeight;
    
    // Logic
    if(KEYS['Space'] && game.p.heat<100) {
        if(frameCount%10==0) {
            game.objs.push({type:'bull',x:game.p.x,y:game.p.y,vy:-15});
            game.p.heat+=5;
        }
    }
    if(game.p.heat>0) game.p.heat-=0.5;
    
    // Mouse/Touch Move
    if(targetX) {
        game.p.x += (targetX - game.p.x)*0.2;
        game.p.y += (targetY - game.p.y)*0.2;
    }

    // Objs
    game.objs.forEach((o,i)=>{
        if(o.type=='bull') o.y+=o.vy;
        if(o.type=='en') o.y+=2;
        
        // Hit Logic
        if(o.type=='en' && Math.abs(o.x-game.p.x)<30 && Math.abs(o.y-game.p.y)<30) {
            game.p.hp-=10; o.dead=true;
        }
    });
    
    game.objs = game.objs.filter(o=>!o.dead && o.y<cvs.height && o.y>-100);
    if(game.objs.filter(o=>o.type=='en').length==0) game.nextWave();
    if(game.p.hp<=0) game.end();

    // Draw
    ctx.clearRect(0,0,cvs.width,cvs.height);
    ctx.font="40px Arial"; ctx.textAlign="center"; 
    ctx.fillText("üöÄ", game.p.x, game.p.y);
    
    game.objs.forEach(o=>{
        if(o.type=='bull') { ctx.fillStyle="#0f0"; ctx.fillRect(o.x-2,o.y,4,10); }
        if(o.type=='en') ctx.fillText(game.mode=='Classic'?"üêî":"‚òÑÔ∏è", o.x, o.y);
    });

    // HUD Update
    document.getElementById('bar-hp').style.width=game.p.hp+'%';
    document.getElementById('bar-heat').style.width=game.p.heat+'%';
    
    frameCount++;
}

let targetX=0, targetY=0, frameCount=0;
window.onpointermove = e => { targetX=e.clientX; targetY=e.clientY; };
window.onkeydown = e => KEYS[e.code]=true;
window.onkeyup = e => KEYS[e.code]=false;
window.onload = ()=> { 
    if(localStorage.getItem('px_t')) toast("Welcome Back");
    app.cvs.width=window.innerWidth; app.cvs.height=window.innerHeight;
    // Mobile Init
    if('ontouchstart' in window) {
        document.getElementById('mobile-controls').style.display='block';
        let z=document.getElementById('zone-move');
        z.ontouchmove=e=>{e.preventDefault(); targetX=e.touches[0].clientX; targetY=e.touches[0].clientY;}
        document.getElementById('btn-fire').ontouchstart=e=>{KEYS['Space']=true;}
        document.getElementById('btn-fire').ontouchend=e=>{KEYS['Space']=false;}
    }
};
function v(id){ return document.getElementById(id).value; }
function toast(m){ let t=document.getElementById('toast'); t.innerText=m; t.style.opacity=1; setTimeout(()=>t.style.opacity=0,2000); }

</script>
</body>
</html>
