<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brigagame v6.0 BOSS EDITION</title>
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />

    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --main: #00f0ff; --warn: #ff0055; --gold: #ffd700; --hp: #00ff00; --bg: #050505; --panel: rgba(10,15,20,0.95); }
        body { margin: 0; overflow: hidden; background: var(--bg); color: #fff; font-family: 'Rajdhani', sans-serif; user-select: none; cursor: crosshair; }
        
        #gameCanvas { display: block; position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; }
        
        /* SCANLINE & VIGNETTE */
        body::after { content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0; background: radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(0,0,0,0.6) 100%), linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%); z-index: 5; background-size: 100% 100%, 100% 3px; pointer-events: none; }

        .screen { position: absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; background: var(--bg); z-index:10; transition:0.3s; }
        .hidden { display: none !important; }
        .overlay { background: rgba(0,0,0,0.85); z-index: 100; backdrop-filter: blur(5px); }

        /* FOOTER */
        #global-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.8); border-top: 1px solid #333; padding: 5px 0; text-align: center; font-size: 14px; color: #888; z-index: 2000; pointer-events: none; }
        #global-footer span { color: var(--main); }

        /* UI */
        .box { background: var(--panel); border: 1px solid var(--main); padding: 20px; border-radius: 4px; text-align: center; box-shadow: 0 0 25px rgba(0,240,255,0.15); position: relative; }
        input, select, textarea { background: #111; border: 1px solid #444; color: white; padding: 8px; margin: 5px; text-align: center; font-family: inherit; font-size: 16px; width: 80%; }
        textarea { text-align: left; resize: none; height: 80px; }
        button { background: rgba(0,240,255,0.1); border: 1px solid var(--main); color: var(--main); padding: 8px 20px; cursor: pointer; margin: 5px; font-weight: bold; font-family: inherit; text-transform: uppercase; transition: 0.2s; }
        button:hover { background: var(--main); color: black; box-shadow: 0 0 10px var(--main); }
        button.gold { border-color: var(--gold); color: var(--gold); }
        button.gold:hover { background: var(--gold); color: black; }
        button.danger { border-color: var(--warn); color: var(--warn); }
        button.danger:hover { background: var(--warn); color: white; }

        .rank-display { color: var(--gold); font-size: 14px; letter-spacing: 2px; border: 1px solid var(--gold); padding: 2px 8px; display: inline-block; margin-top: 5px; }

        /* CARDS */
        .skin-card, .upgrade-card { border: 1px solid #444; padding: 15px; margin: 5px; display: inline-block; width: 140px; cursor: pointer; vertical-align: top; background: rgba(0,0,0,0.3); }
        .skin-card.equipped { border-color: var(--main); background: rgba(0,240,255,0.2); }
        .upgrade-card:hover { border-color: var(--gold); }
        
        /* TABLES */
        table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; }
        th { color: var(--gold); border-bottom: 1px solid #444; padding: 8px; text-align: left; }
        td { border-bottom: 1px solid #222; padding: 8px; color: #ddd; text-align: left; }
        
        .notification-dot { width: 10px; height: 10px; background: var(--warn); border-radius: 50%; display: inline-block; margin-left: 5px; box-shadow: 0 0 5px var(--warn); animation: pulse 1s infinite; }
        @keyframes pulse { 0% {opacity:0.5;} 50% {opacity:1;} 100% {opacity:0.5;} }
        
        /* NEWS BOX */
        .news-box { border: 1px dashed var(--main); padding: 10px; margin-bottom: 15px; text-align: left; font-size: 13px; color: #aaa; white-space: pre-line; background: rgba(0,0,0,0.4); max-height: 100px; overflow-y: auto; }
        
        /* RADIOS */
        .radio-group { display: flex; justify-content: center; gap: 20px; margin: 15px 0; }
        .radio-group label { cursor: pointer; color: #888; transition: 0.2s; }
        .radio-group input:checked + span { color: var(--main); font-weight: bold; text-shadow: 0 0 10px var(--main); }

        /* HUD EXTRAS */
        #music-btn { position: absolute; top: 20px; right: 250px; border: 1px solid var(--main); background: rgba(0,0,0,0.5); width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; color: var(--main); pointer-events: auto; z-index: 60; }
        #music-btn.active { background: var(--main); color: black; box-shadow: 0 0 15px var(--main); }
        
        #boss-warning { position: absolute; top: 20%; left: 0; width: 100%; text-align: center; color: var(--warn); font-size: 60px; font-weight: bold; letter-spacing: 10px; text-shadow: 0 0 20px red; animation: flash 0.5s infinite; display: none; pointer-events: none; z-index: 55; }
        @keyframes flash { 0% {opacity:1;} 50% {opacity:0;} 100% {opacity:1;} }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="toast" style="position:fixed; top:10%; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.9); padding:10px 40px; border:1px solid var(--main); z-index:3000; opacity:0; pointer-events:none; transition:0.3s; color:white; font-weight:bold;">MSG</div>
    
    <div id="global-footer">DEV: <span>OrelAi</span> | CONTACT: <span style="color:gold">ubriga@gmail.com</span> | v6.0 BOSS EDITION</div>

    <canvas id="gameCanvas"></canvas>

    <!-- PAUSE MENU -->
    <div id="screen-pause" class="screen overlay hidden">
        <h1 style="color: var(--gold); letter-spacing: 10px;">SYSTEM PAUSED</h1>
        <div class="box" style="width: 300px;">
            <button onclick="game.resume()" style="width: 100%; margin-bottom: 10px;">RESUME MISSION</button>
            <button onclick="app.toLobby()" class="danger" style="width: 100%;">ABORT MISSION</button>
        </div>
    </div>

    <!-- CHANGE PASSWORD MODAL -->
    <div id="screen-password" class="screen overlay hidden">
        <h3 style="color: var(--main);">SECURITY SETTINGS</h3>
        <div class="box" style="width: 350px;">
            <input type="password" id="cp-old" placeholder="CURRENT PASSWORD"><br>
            <input type="password" id="cp-new" placeholder="NEW PASSWORD"><br>
            <br>
            <button onclick="auth.changePassword()">UPDATE</button>
            <button onclick="document.getElementById('screen-password').classList.add('hidden')" style="border:none; color:#888;">CANCEL</button>
        </div>
    </div>

    <!-- HUD -->
    <div id="game-ui" class="hidden" style="z-index: 50; position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;">
        <div id="music-btn" onclick="sfx.toggleMusic()">üéµ</div>
        
        <div style="position:absolute; top:20px; left:20px; background:rgba(0,0,0,0.5); padding:10px; border:1px solid #444; width: 200px; pointer-events:auto;">
            <div style="margin-bottom:5px; font-size:12px; color:var(--hp)">HP (HULL INTEGRITY)</div>
            <div style="background:#333; height:10px; width:100%;"><div id="bar-hp" style="background:var(--hp); height:100%; width:100%;"></div></div>
            
            <div style="margin:5px 0; font-size:12px; color:#f90">HEAT</div>
            <div style="background:#333; height:10px; width:100%;"><div id="bar-heat" style="background:#f90; height:100%; width:0%;"></div></div>
            
            <div id="buff-ui" style="margin-top:5px; font-size:12px; color:cyan; display:none;">SYSTEM OVERDRIVE ACTIVE!</div>
        </div>

        <div style="position:absolute; top:20px; right:20px; text-align:right;">
            <div style="font-size:30px; font-weight:bold;"><span id="g-score">0</span></div>
            <div style="color:var(--main);">WAVE <span id="g-wave">1</span> <span id="g-diff" style="font-size:12px; color:#aaa;">(NORMAL)</span></div>
            <div style="font-size:10px; color:#aaa;">[ESC] TO PAUSE</div>
        </div>
        <div style="position:absolute; bottom:50px; left:50%; transform:translateX(-50%); text-align:center; pointer-events:auto;">
             <button onclick="game.useDrone()" style="width:60px; height:60px; border-radius:50%; font-size:24px; border:2px solid var(--main); background:rgba(0,0,0,0.6);">üõ∏</button>
             <div style="font-size:10px;">x<span id="drone-qty">0</span></div>
        </div>
        <div id="wave-text" style="position:absolute; top:40%; left:50%; transform:translate(-50%,-50%); font-size:80px; color:var(--main); opacity:0; transition:0.5s;">WAVE 1</div>
        <div id="overheat-msg" style="position:absolute; top:30%; left:50%; transform:translateX(-50%); color:var(--warn); font-size:30px; border:2px solid var(--warn); padding:10px; display:none; background:#000;">OVERHEAT!<br><span style="font-size:14px">COOLING DOWN...</span></div>
        <div id="boss-warning">‚ö†Ô∏è WARNING: BOSS DETECTED ‚ö†Ô∏è</div>
    </div>

    <!-- LOBBY -->
    <div id="screen-lobby" class="screen hidden">
        <div style="position:absolute; top:20px; right:20px; text-align:right;">
            <div style="font-size:20px;">CMD. <span id="l-user" style="color:var(--main)">User</span></div>
            <div id="l-rank" class="rank-display">PRIVATE</div>
            <div style="color:gold; margin-top:5px;">üíé <span id="l-credits">0</span></div>
            <div style="margin-top:10px;">
                <button onclick="document.getElementById('screen-password').classList.remove('hidden')" style="font-size:12px; padding:4px 10px;">üîë</button>
                <button onclick="auth.logout()" style="font-size:12px; padding:4px 10px; border:1px solid #444; color:#888;">LOGOUT</button>
            </div>
        </div>
        
        <h1 style="font-size:70px; margin:0; text-shadow:0 0 30px var(--main);">BRIGAGAME</h1>
        <div style="color:#666; letter-spacing:5px; margin-bottom:15px;">v6.0 BOSS EDITION</div>

        <!-- RELEASE NOTES -->
        <div style="width: 850px; margin-bottom: 10px;">
             <h4 style="margin:0 0 5px 0; color:var(--main); text-align:left;">LATEST INTEL</h4>
             <div id="release-notes" class="news-box">Loading...</div>
        </div>
        
        <div class="box" style="width:850px; min-height:450px;">
            <div class="tabs">
                <div class="tab active" onclick="app.tab('ops')">OPERATIONS</div>
                <div class="tab" onclick="app.tab('armory')">ARMORY</div>
                <div class="tab" onclick="app.tab('hangar')">HANGAR</div>
                <div class="tab" onclick="app.tab('leaderboard')">LEADERS</div> 
                <div class="tab" onclick="app.tab('admin')" id="tab-admin-btn" style="display:none; color:gold; border-color:gold;">
                    ADMIN <span id="adm-badge" class="notification-dot hidden"></span>
                </div>
            </div>

            <!-- OPS -->
            <div id="tab-ops" class="tab-content">
                <div style="display:flex; gap:30px; justify-content:center; align-items:center; height:400px;">
                    <div style="width:40%;">
                        <h3 style="color:var(--main);">MISSION PROTOCOL</h3>
                        <label style="color:#aaa; font-size:12px;">THREAT LEVEL</label><br>
                        <select id="diff-select" style="margin-bottom:10px;">
                            <option value="1">RECRUIT (EASY)</option>
                            <option value="2" selected>SOLDIER (NORMAL)</option>
                            <option value="3">VETERAN (HARD)</option>
                            <option value="4">ELITE (INSANE)</option>
                            <option value="5">LEGEND (IMPOSSIBLE)</option>
                        </select>

                        <!-- FIRE MODE TOGGLE -->
                        <div class="radio-group">
                            <label><input type="radio" name="firemode" value="auto" checked hidden><span>AUTO FIRE</span></label>
                            <label><input type="radio" name="firemode" value="manual" hidden><span>MANUAL (SPACE)</span></label>
                        </div>

                        <button onclick="game.start()" style="width:100%; padding:25px; font-size:24px;">LAUNCH</button>
                        <button onclick="app.redeem()" style="width:100%; margin-top:15px;">REDEEM CODE</button>
                    </div>
                    <div style="width:40%;">
                        <h3 style="color:gold;">SUPPLY</h3>
                        <div style="border:1px solid #444; padding:20px;">
                            <div style="font-size:20px;">üõ∏ DRONE</div>
                            <button onclick="shop.buy('consumable','drone_support',500)" class="gold" style="width:100%;">BUY (500)</button>
                            <div style="margin-top:5px; font-size:12px;">OWNED: <span id="l-drone">0</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ARMORY (UPGRADES) -->
            <div id="tab-armory" class="tab-content hidden">
                 <div id="upgrade-grid"></div>
            </div>

            <!-- HANGAR (SKINS) -->
            <div id="tab-hangar" class="tab-content hidden">
                <div id="skin-grid"></div>
            </div>

            <!-- LEADERBOARD -->
            <div id="tab-leaderboard" class="tab-content hidden">
                <h3 style="color:gold;">TOP PILOTS</h3>
                <div style="height:350px; overflow-y:auto;">
                    <table id="leaderboard-table"><thead><tr><th>RANK</th><th>PILOT</th><th>SCORE</th><th>WAVE</th><th>DIFF</th></tr></thead><tbody></tbody></table>
                </div>
                <button onclick="app.loadLeaderboard()" style="margin-top:10px;">REFRESH</button>
            </div>
            
            <!-- ADMIN -->
            <div id="tab-admin" class="tab-content hidden">
                <div id="adm-login-view">
                    <h3 style="color:gold;">SECURE ACCESS</h3>
                    <input type="password" id="adm-pin" placeholder="PIN CODE" style="font-size:20px; letter-spacing:5px;">
                    <br><br><button onclick="admin.login()" class="gold">ACCESS</button>
                </div>

                <div id="adm-panel" class="hidden" style="text-align:left; height:450px; display:flex; flex-direction:column;">
                    <div class="adm-sub-tabs">
                        <div class="adm-tab active" onclick="admin.subTab('users')">USERS</div>
                        <div class="adm-tab" onclick="admin.subTab('coupons')">COUPONS</div>
                        <div class="adm-tab" onclick="admin.subTab('config')">ECONOMY & NEWS</div>
                    </div>
                    <div id="adm-sub-users" style="flex:1; display:flex; flex-direction:column;">
                        <div style="margin-bottom:10px;">
                            <input type="text" id="adm-search" placeholder="Search..." onkeyup="admin.filterUsers()" style="width:200px;">
                            <button onclick="admin.refresh()">REFRESH</button>
                        </div>
                        <div style="flex:1; overflow-y:auto;">
                            <table id="adm-table-users"><thead><tr><th>ID</th><th>USER</th><th>XP</th><th>STATUS</th><th>ACT</th></tr></thead><tbody></tbody></table>
                        </div>
                    </div>
                    <div id="adm-sub-coupons" class="hidden" style="flex:1; display:flex; flex-direction:column;">
                        <div style="border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:10px;">
                            <h4 style="margin:0 0 5px 0; color:gold;">CREATE COUPON</h4>
                            <input type="text" id="cp-code" placeholder="Code (Empty=Random)" style="width:150px;">
                            <button onclick="document.getElementById('cp-code').value='PRO-'+Math.random().toString(36).substr(2,6).toUpperCase()" style="font-size:10px;">RND</button>
                            <input type="number" id="cp-val" placeholder="Value" style="width:80px;">
                            <input type="number" id="cp-uses" placeholder="Uses" value="1" style="width:60px;">
                            <input type="number" id="cp-hours" placeholder="Hours (0=Forever)" value="24" style="width:120px;">
                            <button onclick="admin.createCoupon()" class="gold">CREATE</button>
                        </div>
                        <div style="flex:1; overflow-y:auto;">
                            <table id="adm-table-coupons"><thead><tr><th>CODE</th><th>VAL</th><th>USES</th><th>EXP</th><th>ACT</th></tr></thead><tbody></tbody></table>
                        </div>
                    </div>
                    <div id="adm-sub-config" class="hidden" style="flex:1; overflow-y:auto; padding:10px;">
                        <h4 style="color:var(--main);">RELEASE NOTES</h4>
                        <textarea id="conf-notes" style="width:90%; color:#fff;"></textarea>
                        
                        <h4 style="color:gold; margin-top:20px;">ECONOMY (BASE PRICE / STEP PRICE)</h4>
                        <div id="conf-prices"></div>
                        
                        <button onclick="admin.saveConfig()" class="gold" style="width:200px; margin-top:20px;">SAVE CHANGES</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIN -->
    <div id="screen-login" class="screen">
        <h1 style="font-size:90px; margin:0; text-shadow:0 0 40px var(--main);">BRIGAGAME</h1>
        <div class="box">
            <input type="text" id="inp-u" placeholder="PILOT ID"><br>
            <input type="password" id="inp-p" placeholder="ACCESS CODE"><br>
            <br>
            <button onclick="auth.login()" style="width:100%;">LOGIN</button>
            <button onclick="auth.register()" class="gold" style="width:100%;">REGISTER</button>
        </div>
    </div>

<script>
/** BRIGAGAME v6.0 BOSS EDITION **/
const API = "https://ubriga.pythonanywhere.com";
var USER=null, TOKEN=localStorage.getItem('px_token');
var KEYS = {}; 

const RANKS = [
    {xp:0, name:"Private"}, {xp:1000, name:"Private 2"}, {xp:2500, name:"Private 1st Class"},
    {xp:5000, name:"Specialist"}, {xp:10000, name:"Corporal"}, {xp:20000, name:"Sergeant"},
    {xp:35000, name:"Staff Sergeant"}, {xp:50000, name:"Sergeant 1st Class"}, {xp:75000, name:"Master Sergeant"},
    {xp:100000, name:"First Sergeant"}, {xp:150000, name:"Sergeant Major"}, {xp:200000, name:"Command Sgt Major"},
    {xp:300000, name:"2nd Lieutenant"}, {xp:400000, name:"1st Lieutenant"}, {xp:500000, name:"Captain"},
    {xp:650000, name:"Major"}, {xp:800000, name:"Lt Colonel"}, {xp:1000000, name:"Colonel"},
    {xp:1500000, name:"Brigadier General"}, {xp:2000000, name:"Major General"}, {xp:3000000, name:"Lt General"},
    {xp:5000000, name:"General"}, {xp:10000000, name:"General of the Army"}
];

function getRankName(xp) {
    let r = RANKS[0].name;
    for(let i=0; i<RANKS.length; i++) { if(xp >= RANKS[i].xp) r = RANKS[i].name; else break; }
    return r;
}

/* AUDIO ENGINE */
const sfx = {
    ctx: null,
    musicOn: false,
    musicTimer: null,
    init: () => {
        if(!sfx.ctx) { sfx.ctx = new (window.AudioContext || window.webkitAudioContext)(); }
        if(sfx.ctx.state === 'suspended') sfx.ctx.resume();
    },
    toggleMusic: () => {
        sfx.init();
        sfx.musicOn = !sfx.musicOn;
        document.getElementById('music-btn').classList.toggle('active', sfx.musicOn);
        if(sfx.musicOn) sfx.startMusic(); else sfx.stopMusic();
    },
    startMusic: () => {
        if(sfx.musicTimer) return;
        let noteIdx = 0;
        const notes = [110, 110, 130, 110, 98, 98, 130, 146]; // Bassline A2, C3, G2 etc.
        const speed = 250;
        sfx.musicTimer = setInterval(() => {
            if(!g.run || g.paused) return; // Only play if game running
            const osc = sfx.ctx.createOscillator();
            const gain = sfx.ctx.createGain();
            osc.connect(gain); gain.connect(sfx.ctx.destination);
            osc.type = 'sawtooth';
            osc.frequency.value = notes[noteIdx] * 0.5; // Bass oct
            gain.gain.setValueAtTime(0.05, sfx.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, sfx.ctx.currentTime + 0.2);
            osc.start(); osc.stop(sfx.ctx.currentTime + 0.2);
            noteIdx = (noteIdx + 1) % notes.length;
        }, speed);
    },
    stopMusic: () => {
        if(sfx.musicTimer) { clearInterval(sfx.musicTimer); sfx.musicTimer = null; }
    },
    play: (type) => {
        if(!sfx.ctx) return;
        const osc = sfx.ctx.createOscillator();
        const gain = sfx.ctx.createGain();
        osc.connect(gain);
        gain.connect(sfx.ctx.destination);
        const now = sfx.ctx.currentTime;
        
        if(type === 'shoot') {
            osc.type = 'triangle'; osc.frequency.setValueAtTime(400, now); osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
            gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.start(now); osc.stop(now + 0.1);
        } else if(type === 'boom') {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.exponentialRampToValueAtTime(10, now + 0.3);
            gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
            osc.start(now); osc.stop(now + 0.3);
        } else if(type === 'hit') {
            osc.type = 'square'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now + 0.1);
            gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0.01, now + 0.1);
            osc.start(now); osc.stop(now + 0.1);
        } else if(type === 'powerup') {
            osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(800, now + 0.3);
            gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0.01, now + 0.3);
            osc.start(now); osc.stop(now + 0.3);
        }
    }
};

const ART = {
    ship: (ctx, type, c, dash, hpRatio) => {
        ctx.save();
        // Dynamic Color based on HP
        if(hpRatio < 0.3) c = '#ff0000';
        
        ctx.shadowBlur=15; ctx.shadowColor=c; ctx.strokeStyle=c; ctx.lineWidth=2; ctx.beginPath();
        
        if(type === 'boss') {
            // BOSS ART
            ctx.shadowBlur=30; ctx.lineWidth=4;
            ctx.moveTo(0, 40); ctx.lineTo(30, -20); ctx.lineTo(60, -40); ctx.lineTo(20, -60);
            ctx.lineTo(-20, -60); ctx.lineTo(-60, -40); ctx.lineTo(-30, -20); ctx.closePath();
            ctx.stroke();
            // Core
            ctx.fillStyle = `rgba(255, 0, 0, ${0.5 + Math.random()*0.5})`;
            ctx.beginPath(); ctx.arc(0, -20, 10, 0, Math.PI*2); ctx.fill();
        } 
        else if(type==='golden') { 
            ctx.moveTo(0,-20); ctx.lineTo(15,10); ctx.lineTo(0,15); ctx.lineTo(-15,10); ctx.closePath(); 
            ctx.rect(-10,10,5,5); ctx.rect(5,10,5,5); 
        }
        else if(type==='crimson') { 
            ctx.moveTo(0,-25); ctx.lineTo(10,5); ctx.lineTo(20,20); ctx.lineTo(0,10); ctx.lineTo(-20,20); ctx.lineTo(-10,5); ctx.closePath(); 
        }
        else { // Default Player / Enemy
            ctx.moveTo(0,-20); ctx.lineTo(10,10); ctx.lineTo(0,5); ctx.lineTo(-10,10); ctx.closePath(); 
            // Wings
            ctx.moveTo(0,0); ctx.lineTo(18,12); ctx.moveTo(0,0); ctx.lineTo(-18,12);
        }
        
        ctx.stroke(); ctx.fillStyle=c; ctx.globalAlpha=0.15; ctx.fill(); 
        
        // Engine
        if(dash) { 
            ctx.globalAlpha=1; ctx.beginPath(); ctx.moveTo(-5,10); 
            ctx.lineTo(0, 20 + Math.random()*15); ctx.lineTo(5,10); 
            ctx.fillStyle= (type==='boss') ? '#f00' : c; 
            ctx.fill(); 
        }
        ctx.restore();
    },
    drone: (ctx) => {
        ctx.shadowBlur=15; ctx.shadowColor='gold'; ctx.strokeStyle='gold'; ctx.lineWidth=2; 
        ctx.beginPath(); ctx.arc(0,0,5,0,7); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(-10,0); ctx.lineTo(10,0); ctx.moveTo(0,-10); ctx.lineTo(0,10); ctx.stroke();
        ctx.beginPath(); ctx.arc(0,0,12,0,Math.PI*2); ctx.setLineDash([2,4]); ctx.stroke();
    },
    drop: (ctx, type) => {
        ctx.shadowBlur=10; 
        if(type==='HP') { ctx.fillStyle='#0f0'; ctx.shadowColor='#0f0'; ctx.fillText('‚úö',-5,5); }
        else if(type==='ENG') { ctx.fillStyle='#ff0'; ctx.shadowColor='#ff0'; ctx.fillText('‚ö°',-5,5); }
        else { ctx.fillStyle='#0ff'; ctx.shadowColor='#0ff'; ctx.fillText('üõ°Ô∏è',-6,5); }
        ctx.beginPath(); ctx.arc(0,0,10,0,7); ctx.strokeStyle=ctx.fillStyle; ctx.stroke();
    }
};

const SKINS = {
    'default': { name: 'VIPER', color: '#00f0ff', cost: 0, type: 'default' },
    'crimson': { name: 'PHANTOM', color: '#ff0055', cost: 2000, type: 'crimson' },
    'golden': { name: 'TITAN', color: '#ffd700', cost: 5000, type: 'golden' }
};

var UPGRADES = {
    'double_shot': { name: "DOUBLE SHOT", base: 10000, step: 0, max: 1, desc: "ULTIMATE: Fire 2 bullets" },
    'fire_rate': { name: "RAPID FIRE", base: 1000, step: 1000, max: 10, desc: "+10% Fire Rate / Lvl" },
    'damage': { name: "POWER CORE", base: 1000, step: 1000, max: 10, desc: "+2 Damage / Lvl" },
    'hull': { name: "TITANIUM HULL", base: 1000, step: 1000, max: 10, desc: "+10 Max HP / Lvl" }
};

const toast = (m) => { const t=document.getElementById('toast'); t.innerText=m; t.style.opacity=1; setTimeout(()=>t.style.opacity=0,3000); };
const getHeader = () => ({'Content-Type':'application/json', 'Authorization': `Bearer ${TOKEN}`});
const v = (id) => document.getElementById(id).value;

var app = {
    init: async () => {
        try {
            const res = await fetch(`${API}/get_config`);
            const conf = await res.json();
            if(conf.prices) {
                const prices = JSON.parse(conf.prices);
                for(let k in prices) {
                    if(UPGRADES[k]) { UPGRADES[k].base = parseInt(prices[k].base); UPGRADES[k].step = parseInt(prices[k].step); }
                }
            }
            if(conf.release_notes) {
                document.getElementById('release-notes').innerText = conf.release_notes;
            }
        } catch(e) { console.error("Config load failed"); }

        if(TOKEN) auth.validate(); else app.show('screen-login');
        window.onresize = () => { canvas.width=innerWidth; canvas.height=innerHeight; };
        
        window.addEventListener('keydown', e => { 
            KEYS[e.code] = true;
            const manual = document.querySelector('input[name="firemode"]:checked').value === 'manual';
            if (manual && e.code === 'KeyV') game.vent();
            if (!manual && e.code === 'Space') game.vent();
            if(e.code==='Escape') game.togglePause(); 
        });
        window.addEventListener('keyup', e => { KEYS[e.code] = false; });
        window.addEventListener('mousemove', e => { mouse.x=e.clientX; mouse.y=e.clientY; });
        
        game.initStars();
        document.addEventListener('click', sfx.init, {once:true});
    },
    show: (id) => {
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById('game-ui').classList.add('hidden');
        if(id) document.getElementById(id).classList.remove('hidden');
    },
    toLobby: () => { game.stop(); app.show('screen-lobby'); app.updateUI(); },
    tab: (t) => {
        if(t==='admin' && !USER.is_admin) return toast("DENIED");
        document.querySelectorAll('.tab-content').forEach(c=>c.classList.add('hidden'));
        document.getElementById(`tab-${t}`).classList.remove('hidden');
        document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
        const btn = document.querySelector(`.tab[onclick*="'${t}'"]`);
        if(btn) btn.classList.add('active');
        if(t==='leaderboard') app.loadLeaderboard();
        if(t==='admin') admin.renderConfig();
    },
    updateUI: async () => {
        if(!USER) return;
        document.getElementById('l-user').innerText = USER.username;
        document.getElementById('l-credits').innerText = USER.credits;
        document.getElementById('l-rank').innerText = getRankName(USER.total_xp || 0);
        document.getElementById('l-drone').innerText = (USER.consumables?.drone_support)||0;
        
        const admBtn = document.getElementById('tab-admin-btn');
        if(USER.is_admin) {
            admBtn.style.display = 'block';
            try {
                const res = await fetch(`${API}/admin/dashboard`, {headers:getHeader()});
                const d = await res.json();
                const pending = d.users.filter(u => !u.approved).length;
                const badge = document.getElementById('adm-badge');
                if(pending > 0) badge.classList.remove('hidden'); else badge.classList.add('hidden');
            } catch(e) {}
        }

        const grid = document.getElementById('skin-grid'); grid.innerHTML = '';
        Object.keys(SKINS).forEach(key => {
            const s = SKINS[key];
            const owned = USER.inventory[key] || key==='default';
            const equipped = USER.inventory.active_skin === key;
            const card = document.createElement('div'); card.className = `skin-card ${equipped?'equipped':''}`; card.style.borderColor = s.color;
            card.innerHTML = `<div style="color:${s.color}; font-size:24px;">üöÄ</div><div>${s.name}</div><div style="font-size:10px;">${owned ? (equipped?'EQUIPPED':'OWNED') : s.cost}</div>`;
            card.onclick = () => shop.handleSkin(key, s.cost, owned);
            grid.appendChild(card);
        });

        const uGrid = document.getElementById('upgrade-grid'); uGrid.innerHTML = '';
        Object.keys(UPGRADES).forEach(key => {
            const u = UPGRADES[key];
            const level = USER.inventory[key] || 0;
            const isMax = level >= u.max;
            const nextCost = u.base + (level * u.step);
            
            const card = document.createElement('div'); card.className = `upgrade-card`; card.style.borderColor = isMax?'var(--gold)':'#444';
            
            card.innerHTML = `
                <div style="color:var(--main); font-size:24px;">‚ö°</div>
                <div>${u.name}</div>
                <div style="font-size:10px; color:#aaa;">${u.desc}</div>
                <div style="margin:5px 0; font-size:11px; color:white;">LVL ${level} / ${u.max}</div>
                <div style="font-size:12px; color:${isMax?'#0f0':'gold'}">${isMax ? 'MAXED' : nextCost}</div>
            `;
            if(!isMax) card.onclick = () => shop.buy('upgrade', key, nextCost);
            uGrid.appendChild(card);
        });
    },
    loadLeaderboard: async () => {
        try {
            const res = await fetch(`${API}/leaderboard`, {headers:getHeader()});
            const list = await res.json();
            document.querySelector('#leaderboard-table tbody').innerHTML = list.map((r,i) => 
                `<tr><td style="color:${i<3?'gold':'#ddd'}">${i+1}</td><td>${r.player}</td><td>${r.score}</td><td>${r.wave}</td><td style="font-size:10px;color:#aaa;">${r.diff}</td></tr>`
            ).join('');
        } catch(e) {}
    },
    redeem: async () => {
        const c=prompt("CODE:"); if(!c) return;
        const res = await fetch(`${API}/redeem_coupon`, {method:'POST', headers:getHeader(), body:JSON.stringify({code:c})});
        const d = await res.json();
        if(d.error) return toast(d.error);
        USER.credits += d.added; toast(`+${d.added}`); app.updateUI();
    }
};

var auth = {
    login: async () => {
        const u = v('inp-u'), p = v('inp-p');
        if(!u || !p) return toast("MISSING INFO"); 
        try {
            const res = await fetch(`${API}/login`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u,password:p})});
            const d = await res.json();
            if(d.error) return toast(d.error);
            TOKEN=d.token; USER=d.user; localStorage.setItem('px_token', TOKEN);
            app.toLobby();
        } catch(e) { toast("Conn Error"); }
    },
    register: async () => {
        const u = v('inp-u'), p = v('inp-p');
        if(!u || !p) return toast("MISSING INFO");
        try {
            const res = await fetch(`${API}/register`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u,password:p})});
            const d = await res.json();
            toast(d.message || d.error);
        } catch(e) { toast("Error"); }
    },
    changePassword: async () => {
        const oldP = v('cp-old'), newP = v('cp-new');
        if(!oldP || !newP) return toast("FILL FIELDS");
        try {
            const res = await fetch(`${API}/change_password`, {method:'POST', headers:getHeader(), body:JSON.stringify({old_password:oldP, new_password:newP})});
            const d = await res.json();
            if(d.error) return toast(d.error);
            toast("PASSWORD CHANGED");
            document.getElementById('screen-password').classList.add('hidden');
        } catch(e) { toast("Error"); }
    },
    validate: () => app.show('screen-login'),
    logout: () => { localStorage.removeItem('px_token'); location.reload(); }
};

var shop = {
    buy: async (t,id,c) => {
        if(USER.credits<c) return toast("NO FUNDS");
        const res = await fetch(`${API}/shop/buy`, {method:'POST', headers:getHeader(), body:JSON.stringify({item_type:t, item_id:id, cost:c})});
        const d = await res.json();
        if(d.error) return toast(d.error);
        USER.credits = d.credits;
        if(t==='consumable') USER.consumables[id] = (USER.consumables[id]||0)+1; 
        else if(t==='upgrade') USER.inventory[id] = (USER.inventory[id]||0)+1;
        else USER.inventory[id]=true;
        app.updateUI(); toast("BOUGHT");
    },
    handleSkin: async (k,c,o) => {
        if(o) {
            await fetch(`${API}/shop/equip`, {method:'POST', headers:getHeader(), body:JSON.stringify({skin_id:k})});
            USER.inventory.active_skin = k; app.updateUI(); toast("EQUIPPED");
        } else shop.buy('skin', k, c);
    }
};

var admin = {
    login: async () => { 
        const inputPin = v('adm-pin');
        if(!inputPin) return toast("ENTER PIN");
        try {
            const res = await fetch(`${API}/admin/verify_pin`, { method: 'POST', headers: getHeader(), body: JSON.stringify({ pin: inputPin }) });
            const d = await res.json();
            if (d.status === 'success') {
                document.getElementById('adm-login-view').classList.add('hidden'); 
                document.getElementById('adm-panel').classList.remove('hidden'); 
                admin.refresh(); 
            } else { toast("ACCESS DENIED"); }
        } catch(e) { toast("ERROR"); }
    },
    subTab: (t) => { 
        document.querySelectorAll('.adm-sub-tabs div').forEach(d=>d.classList.remove('active'));
        document.getElementById('adm-sub-users').classList.add('hidden'); 
        document.getElementById('adm-sub-coupons').classList.add('hidden'); 
        document.getElementById('adm-sub-config').classList.add('hidden');
        document.getElementById(`adm-sub-${t}`).classList.remove('hidden'); 
    },
    refresh: async () => { try { const res = await fetch(`${API}/admin/dashboard`, {headers:getHeader()}); const d = await res.json(); adminData = d; admin.renderUsers(d.users); admin.renderCoupons(d.coupons); } catch(e) { toast("Load Error"); } },
    renderUsers: (list) => { 
        document.querySelector('#adm-table-users tbody').innerHTML = list.map(u => `<tr>
            <td>${u.id}</td>
            <td style="color:${u.admin?'gold':'white'}">${u.username}</td>
            <td>${u.xp||0}</td>
            <td style="color:${u.approved?'#0f0':'#f00'}">${u.approved?'ACTIVE':'WAIT'}</td>
            <td>
                ${!u.approved ? `<button onclick="admin.act('approve_user',{user_id:${u.id}})" style="color:#0f0;font-size:10px;">OK</button>` : ''}
                ${!u.admin ? `<button onclick="admin.act('ban_user',{user_id:${u.id},ban:${!u.banned}})" style="font-size:10px;">${u.banned?'UNBAN':'BAN'}</button>`:''}
                <button onclick="if(confirm('Reset Pass?')) admin.act('reset_pass',{user_id:${u.id}})" style="font-size:10px; color:orange;">RST</button>
                <button onclick="if(confirm('DELETE USER?')) admin.act('delete_user',{user_id:${u.id}})" class="danger" style="font-size:10px;">DEL</button>
            </td>
        </tr>`).join(''); 
    },
    renderCoupons: (list) => { document.querySelector('#adm-table-coupons tbody').innerHTML = list.map(c => `<tr><td style="color:gold;">${c.code}</td><td>${c.value}</td><td>${c.uses}</td><td style="font-size:10px;">${c.expires || 'NEVER'}</td><td><button onclick="admin.act('delete_coupon',{id:${c.id}})" class="danger" style="font-size:10px;">X</button></td></tr>`).join(''); },
    filterUsers: () => { const term = v('adm-search').toLowerCase(); admin.renderUsers(adminData.users.filter(u => u.username.toLowerCase().includes(term))); },
    createCoupon: () => { const code = v('cp-code') || 'PRO-'+Math.random().toString(36).substr(2,6).toUpperCase(); admin.act('create_coupon', { code: code, value: v('cp-val'), uses: v('cp-uses'), hours: v('cp-hours') }); },
    act: async (a, p) => { await fetch(`${API}/admin/action`, {method:'POST', headers:getHeader(), body:JSON.stringify({action:a, ...p})}); admin.refresh(); toast("DONE"); },
    
    renderConfig: () => {
         document.getElementById('conf-notes').value = document.getElementById('release-notes').innerText;
         const pDiv = document.getElementById('conf-prices'); pDiv.innerHTML = '';
         Object.keys(UPGRADES).forEach(k => {
             const u = UPGRADES[k];
             pDiv.innerHTML += `
                 <div style="margin-bottom:5px; border:1px solid #333; padding:5px; display:flex; justify-content:space-between; align-items:center;">
                    <span style="color:gold; width:120px;">${u.name}</span>
                    <input type="number" id="base-${k}" value="${u.base}" placeholder="Base" style="width:80px;">
                    <input type="number" id="step-${k}" value="${u.step}" placeholder="Step" style="width:80px;">
                 </div>
             `;
         });
    },
    saveConfig: async () => {
        const prices = {};
        Object.keys(UPGRADES).forEach(k => {
             prices[k] = {
                 base: parseInt(document.getElementById(`base-${k}`).value),
                 step: parseInt(document.getElementById(`step-${k}`).value)
             };
        });
        const notes = document.getElementById('conf-notes').value;
        
        await fetch(`${API}/admin/save_config`, {
            method:'POST', headers:getHeader(),
            body: JSON.stringify({ prices: prices, release_notes: notes })
        });
        toast("CONFIG SAVED");
        setTimeout(() => location.reload(), 1000); 
    }
};

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
var g = { run: false, paused: false, score: 0, wave: 1, hp: 100, maxHp: 100, heat: 0, energy: 100, frames: 0, diff: 2 };
var player = {x:0, y:0, dashing:0, overheat:false, shield:0, buff:0};
var ents = { bullets:[], enemies:[], drones:[], eBullets:[], waves:[], drops:[] };
var particles = []; 
var stars = [];     
var shake = 0;      
var mouse = {x:0, y:0};
var drones_active = false;
var isManualFire = false;

const DIFF_DATA = [
    {}, 
    { name: "RECRUIT", hpMult: 0.5, spdMult: 0.8, spawnRate: 0.5 },
    { name: "SOLDIER", hpMult: 1.0, spdMult: 1.0, spawnRate: 1.0 },
    { name: "VETERAN", hpMult: 1.5, spdMult: 1.2, spawnRate: 1.5 },
    { name: "ELITE", hpMult: 2.5, spdMult: 1.4, spawnRate: 2.0 },
    { name: "LEGEND", hpMult: 4.0, spdMult: 1.6, spawnRate: 3.0 }
];

var game = {
    initStars: () => {
        stars = [];
        for(let i=0; i<100; i++) {
            stars.push({
                x: Math.random()*innerWidth,
                y: Math.random()*innerHeight,
                s: Math.random()*2,
                v: 1 + Math.random()*4
            });
        }
    },
    start: () => {
        canvas.width = innerWidth; canvas.height = innerHeight;
        game.initStars();
        sfx.init(); 
        if(sfx.musicOn) sfx.startMusic();

        const diffVal = parseInt(v('diff-select'));
        const baseHp = 100 + ((USER.inventory.hull||0) * 10);
        g = { run: true, paused: false, score: 0, wave: 1, hp: baseHp, maxHp: baseHp, heat: 0, energy: 100, frames: 0, diff: diffVal };
        document.getElementById('g-diff').innerText = `(${DIFF_DATA[diffVal].name})`;
        
        isManualFire = document.querySelector('input[name="firemode"]:checked').value === 'manual';
        
        player = { x: canvas.width/2, y: canvas.height/2, dashing:0, overheat:false, shield:0, buff:0 };
        mouse = { x: canvas.width/2, y: canvas.height/2 };
        ents = { bullets:[], enemies:[], drones:[], eBullets:[], waves:[], drops:[] };
        particles = [];
        shake = 0;
        
        app.show(''); document.getElementById('game-ui').classList.remove('hidden');
        document.getElementById('drone-qty').innerText = (USER.consumables?.drone_support)||0;
        game.nextWave(); loop();
    },
    togglePause: () => {
        if(!g.run) return;
        g.paused = !g.paused;
        document.getElementById('screen-pause').classList.toggle('hidden', !g.paused);
        if(!g.paused) loop();
    },
    resume: () => game.togglePause(),
    stop: () => { g.run = false; sfx.stopMusic(); document.getElementById('screen-pause').classList.add('hidden'); },
    nextWave: () => {
        const set = DIFF_DATA[g.diff];
        
        // BOSS WAVE
        if(g.wave % 5 === 0) {
            document.getElementById('boss-warning').style.display='block';
            setTimeout(()=>document.getElementById('boss-warning').style.display='none', 4000);
            
            ents.enemies.push({
                x: canvas.width/2, y: -200, 
                tx: canvas.width/2, ty: 150,
                hp: (500 + g.wave*50) * set.hpMult, 
                maxHp: (500 + g.wave*50) * set.hpMult,
                type: 2, // BOSS
                state: 'FLY',
                offset: 0, sway: 0
            });
            const wt=document.getElementById('wave-text'); wt.innerText=`BOSS WAVE`; wt.style.color='red'; wt.style.opacity=1; setTimeout(()=>wt.style.opacity=0,3000);
            return;
        }

        const count = Math.floor((5 + g.wave*2) * (g.diff*0.5 + 0.5)); 
        
        for(let i=0; i<count; i++) {
            ents.enemies.push({
                x: Math.random()*canvas.width, 
                y: -200 - Math.random()*1000,
                offset: (Math.random() - 0.5) * 400,
                sway: 1 + Math.random() * 2,
                ty: 100 + Math.random()*300,
                hp: (10 + g.wave*5) * set.hpMult, 
                maxHp: (10 + g.wave*5) * set.hpMult,
                type: Math.random()>0.8 ? 1 : 0, 
                state: 'FLY'
            });
        }
        const wt=document.getElementById('wave-text'); wt.innerText=`WAVE ${g.wave}`; wt.style.color='var(--main)'; wt.style.opacity=1; setTimeout(()=>wt.style.opacity=0,2000);
    },
    useDrone: () => {
        if(drones_active) return;
        if((USER.consumables?.drone_support)>0) {
            drones_active = true;
            USER.consumables.drone_support--; document.getElementById('drone-qty').innerText=USER.consumables.drone_support;
            fetch(`${API}/use_consumable`, {method:'POST', headers:getHeader(), body:JSON.stringify({item_id:'drone_support'})})
                .finally(()=> setTimeout(()=>drones_active=false, 1000));
            ents.drones.push({x:player.x, y:player.y, t:600}); toast("DRONE DEPLOYED");
        } else toast("NO DRONES");
    },
    vent: () => { 
        if((g.heat > 80 || player.overheat)) { 
            ents.waves.push({x:player.x, y:player.y, r:10}); 
            g.heat=0; player.overheat=false; 
            document.getElementById('overheat-msg').style.display='none'; 
            spawnExplosion(player.x, player.y, 'cyan', 20);
        } 
    }
};

function spawnExplosion(x, y, c, count) {
    for(let i=0; i<count; i++) {
        particles.push({
            x: x, y: y,
            vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
            life: 1.0, color: c, size: Math.random()*3
        });
    }
}

function loop() {
    if(!g.run || g.paused) return;
    g.frames++;
    
    // Clear & Stars (Parallax)
    ctx.fillStyle='#050505'; ctx.fillRect(0,0,canvas.width,canvas.height);
    
    ctx.fillStyle = '#fff';
    stars.forEach(s => {
        s.y += s.v;
        if(s.y > canvas.height) { s.y = 0; s.x = Math.random()*canvas.width; }
        ctx.globalAlpha = 0.5;
        ctx.beginPath(); ctx.arc(s.x, s.y, s.s, 0, 7); ctx.fill();
    });
    ctx.globalAlpha = 1.0;

    // Screen Shake
    if(shake > 0) {
        let dx = (Math.random()-0.5)*shake; let dy = (Math.random()-0.5)*shake;
        ctx.save(); ctx.translate(dx, dy);
        shake *= 0.9; if(shake < 1) shake = 0;
    }

    ctx.globalCompositeOperation = 'lighter';

    if (!(mouse.x === 0 && mouse.y === 0)) {
        player.x += (mouse.x - player.x) * 0.1;
        player.y += (mouse.y - player.y) * 0.1;
        player.x = Math.max(20, Math.min(canvas.width - 20, player.x));
        player.y = Math.max(canvas.height * 0.5, Math.min(canvas.height - 20, player.y));
    }
    
    // Player Buffs
    if(player.shield > 0) player.shield--;
    if(player.buff > 0) { player.buff--; if(player.buff===0) document.getElementById('buff-ui').style.display='none'; }

    ctx.save(); ctx.translate(player.x, player.y);
    const skinKey = USER.inventory.active_skin || 'default';
    const skin = SKINS[skinKey] || SKINS['default'];
    // Shield Visual
    if(player.shield > 0) {
        ctx.beginPath(); ctx.arc(0,0,30,0,Math.PI*2); ctx.strokeStyle='cyan'; ctx.lineWidth=2; 
        ctx.setLineDash([5,5]); ctx.stroke(); ctx.setLineDash([]);
    }
    ART.ship(ctx, skin.type, skin.color, true, g.hp/g.maxHp);
    ctx.restore();

    if(g.heat>0 && player.buff===0) {
        if(player.overheat) g.heat -= 0.15; 
        else g.heat -= 0.25; 
        if(g.heat <= 0) { g.heat=0; player.overheat=false; document.getElementById('overheat-msg').style.display='none'; }
        else if(player.overheat) document.getElementById('overheat-msg').style.display='block';
    }
    
    const hpPct = (g.hp / g.maxHp) * 100;
    document.getElementById('bar-hp').style.width = Math.max(0, hpPct)+'%';
    document.getElementById('bar-heat').style.width = g.heat+'%';

    let fireRate = 8 - ((USER.inventory['fire_rate']||0) * 0.4); 
    if(player.buff > 0) fireRate = 2; // OVERDRIVE
    if(fireRate < 2) fireRate = 2; 

    let shouldShoot = false;
    if (isManualFire) {
        if (KEYS['Space'] && g.frames % Math.floor(fireRate) === 0) shouldShoot = true;
    } else {
        if (g.frames % Math.floor(fireRate) === 0 && mouse.y < player.y) shouldShoot = true;
    }

    if(shouldShoot && (!player.overheat || player.buff > 0)) { 
        const dmg = 10 + ((USER.inventory['damage']||0) * 2);
        const double = USER.inventory['double_shot'];
        sfx.play('shoot'); 
        
        if(double) {
             ents.bullets.push({x:player.x-10, y:player.y-20, vx:0, vy:-20, c:skin.color, dmg:dmg});
             ents.bullets.push({x:player.x+10, y:player.y-20, vx:0, vy:-20, c:skin.color, dmg:dmg});
             if(player.buff===0) g.heat+=6; 
        } else {
             ents.bullets.push({x:player.x, y:player.y-20, vx:0, vy:-20, c:skin.color, dmg:dmg});
             if(player.buff===0) g.heat+=4; 
        }
        
        if(g.heat>=100 && player.buff===0) { player.overheat=true; }
    }

    // Shockwaves
    ents.waves.forEach((w,i) => {
        w.r+=15; ctx.beginPath(); ctx.arc(w.x,w.y,w.r,0,7); ctx.strokeStyle='white'; ctx.lineWidth=5; ctx.stroke();
        ents.eBullets = ents.eBullets.filter(b=>Math.hypot(b.x-w.x,b.y-w.y)>w.r);
        ents.enemies.forEach(e=>{
            if(Math.hypot(e.x-w.x,e.y-w.y)<w.r) { e.hp-=5; spawnExplosion(e.x, e.y, 'white', 2); sfx.play('hit'); }
        });
        if(w.r>300) ents.waves.splice(i,1);
    });

    const diffSet = DIFF_DATA[g.diff];
    ents.enemies.forEach(e => {
        // BOSS LOGIC
        if(e.type === 2) {
             e.tx = canvas.width/2 + Math.sin(g.frames*0.02) * 200;
             e.x += (e.tx - e.x) * 0.05;
             e.y += (e.ty - e.y) * 0.05;
             
             // Boss Attack
             if(g.frames % 30 === 0) {
                 for(let k=0; k<5; k++) {
                     let ang = (Math.PI/2) + (k-2)*0.2;
                     ents.eBullets.push({x:e.x, y:e.y+40, vx:Math.cos(ang)*5, vy:Math.sin(ang)*5, c:'#f0f'});
                 }
             }
        } else if(e.state==='FLY') {
            e.tx = player.x + e.offset + Math.sin(g.frames * 0.05 * e.sway) * 50; 
            if(e.tx < 20) e.tx = 20; if(e.tx > canvas.width - 20) e.tx = canvas.width - 20;
            e.x += (e.tx - e.x) * 0.02; e.y += (e.ty - e.y) * 0.05;
            if(Math.abs(e.y-e.ty)<5) e.state='ATK';
        } else {
            e.tx = player.x + e.offset + Math.sin(g.frames * 0.05 * e.sway) * 100;
            if(e.tx < 20) e.tx = 20; if(e.tx > canvas.width - 20) e.tx = canvas.width - 20;
            e.x += (e.tx - e.x) * 0.01; 
            if(Math.random() < 0.01 * g.wave * diffSet.spawnRate) {
                ents.eBullets.push({x:e.x, y:e.y+10, vx:0, vy:7*diffSet.spdMult, c:'#f00'});
            }
        }
        
        ctx.save(); ctx.translate(e.x, e.y);
        if(e.type===2) ART.ship(ctx, 'boss', '#f00', true);
        else e.type===0 ? ART.ship(ctx, 'default', 'red', false) : ART.ship(ctx, 'golden', 'orange', false);
        ctx.restore();
        
        if(Math.hypot(e.x-player.x, e.y-player.y) < (e.type===2?60:25)) { 
            if(player.shield===0) { g.hp-=20; shake=20; sfx.play('boom'); spawnExplosion(player.x, player.y, 'red', 10); checkDead(); }
            if(e.type!==2) e.hp=0; 
        }
    });
    
    // Drops
    ents.drops.forEach((d,i) => {
        d.y += 2; 
        ctx.save(); ctx.translate(d.x, d.y); ART.drop(ctx, d.type); ctx.restore();
        if(Math.hypot(d.x-player.x, d.y-player.y) < 30) {
            sfx.play('powerup');
            if(d.type==='HP') { g.hp = Math.min(g.maxHp, g.hp+30); toast("REPAIR +30"); }
            if(d.type==='ENG') { player.buff = 300; document.getElementById('buff-ui').style.display='block'; toast("OVERDRIVE"); }
            if(d.type==='SHD') { player.shield = 300; toast("SHIELD UP"); }
            ents.drops.splice(i,1);
        } else if(d.y > canvas.height) ents.drops.splice(i,1);
    });

    // Enemy Death
    ents.enemies.forEach(e => {
        if(e.hp <= 0 && e.maxHp > 0) { 
            spawnExplosion(e.x, e.y, 'orange', e.type===2 ? 50 : 15);
            sfx.play('boom'); shake = 5;
            // DROP CHANCE
            if(Math.random() < 0.15) {
                const r = Math.random();
                let type = 'HP';
                if(r>0.4) type = 'ENG';
                if(r>0.7) type = 'SHD';
                ents.drops.push({x:e.x, y:e.y, type:type});
            }
        }
    });
    
    ents.enemies = ents.enemies.filter(e=>e.hp>0);
    if(ents.enemies.length===0) { g.wave++; game.nextWave(); }

    ents.bullets.forEach((b,i) => {
        b.y+=b.vy; ctx.fillStyle=b.c; ctx.beginPath(); ctx.arc(b.x,b.y,3,0,7); ctx.fill();
        ctx.beginPath(); ctx.moveTo(b.x, b.y); ctx.lineTo(b.x, b.y-10); ctx.strokeStyle=b.c; ctx.stroke();
        
        if(b.y<0) ents.bullets.splice(i,1);
        else ents.enemies.forEach(e=>{ 
            let dist = (e.type===2) ? 50 : 25;
            if(Math.hypot(b.x-e.x,b.y-e.y)<dist) { 
                e.hp -= (b.dmg || 10); 
                spawnExplosion(b.x, b.y, b.c, 3);
                sfx.play('hit');
                ents.bullets.splice(i,1); 
                if(e.hp<=0) { g.score+=10 * g.diff * (e.type===2?10:1); document.getElementById('g-score').innerText=g.score; } 
            } 
        });
    });

    ents.eBullets.forEach((b,i) => {
        b.y+=b.vy; ctx.fillStyle='#fff'; ctx.shadowBlur=10; ctx.shadowColor=b.c; ctx.beginPath(); ctx.arc(b.x,b.y,4,0,7); ctx.fill();
        if(b.y>canvas.height) ents.eBullets.splice(i,1);
        else if(Math.hypot(b.x-player.x,b.y-player.y)<15) { 
            if(player.shield===0) {
                g.hp-=5 * diffSet.hpMult; 
                shake = 10; sfx.play('hit'); spawnExplosion(b.x, b.y, 'red', 5);
                checkDead(); 
            }
            ents.eBullets.splice(i,1); 
        }
    });

    ents.drones = ents.drones.filter(d=>d.t-->0);
    ents.drones.forEach(d => {
        d.x+=(player.x-d.x)*0.1; d.y+=(player.y-d.y)*0.1-40;
        ctx.save(); ctx.translate(d.x, d.y); ART.drone(ctx); ctx.restore();
        if(g.frames%20===0 && ents.enemies.length) {
             const t=ents.enemies[0]; const a=Math.atan2(t.y-d.y, t.x-d.x);
             ents.bullets.push({x:d.x, y:d.y, vx:Math.cos(a)*10, vy:Math.sin(a)*10, c:'gold', dmg:10});
             sfx.play('shoot');
        }
    });

    particles.forEach((p,i) => {
        p.x += p.vx; p.y += p.vy; p.life -= 0.05;
        ctx.globalAlpha = p.life; ctx.fillStyle = p.color;
        ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, 7); ctx.fill();
        if(p.life <= 0) particles.splice(i, 1);
    });
    
    if(shake > 0) ctx.restore(); 
    ctx.globalCompositeOperation = 'source-over';
    ctx.globalAlpha = 1.0;

    requestAnimationFrame(loop);
}

function checkDead() {
    if(g.hp<=0) {
        g.run=false; sfx.stopMusic(); alert(`MISSION FAILED\nSCORE: ${g.score}\nWAVE: ${g.wave}`); app.toLobby();
        fetch(`${API}/submit_score`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({player:USER.username, score:g.score, wave:g.wave, difficulty:DIFF_DATA[g.diff].name})});
    }
}

window.onload = app.init;
</script>
</body>
</html>
