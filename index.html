<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>BRIGA PROTOCOL X - REFORGED</title>
<style>
:root { --main: #00d2ff; --bg: #050510; --panel: rgba(0,20,40,0.9); --danger: #ff0044; }
body { margin:0; overflow:hidden; background:var(--bg); font-family:'Courier New', monospace; color:white; user-select:none; }
canvas { display:block; }

/* UI LAYOUT */
#ui-layer { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; display:flex; flex-direction:column; justify-content:space-between; }
.screen { position:absolute; top:0; left:0; width:100%; height:100%; background:var(--bg); display:flex; flex-direction:column; align-items:center; justify-content:center; pointer-events:auto; z-index:10; }
.hud-panel { padding:10px; background:var(--panel); border:1px solid var(--main); margin:5px; pointer-events:auto; }
button { background:var(--main); color:black; border:none; padding:10px 20px; font-weight:bold; cursor:pointer; margin:5px; font-family:inherit; text-transform:uppercase; clip-path: polygon(10% 0, 100% 0, 100% 80%, 90% 100%, 0 100%, 0 20%); }
button:active { transform:scale(0.95); }
.btn-gold { background:gold; }
.btn-danger { background:var(--danger); color:white; }

/* FORMS & SHOP */
input { background:rgba(0,0,0,0.5); border:1px solid var(--main); color:white; padding:8px; margin:5px; width:200px; text-align:center; }
.shop-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(140px, 1fr)); gap:10px; width:90%; max-height:60vh; overflow-y:auto; padding:10px; }
.shop-item { background:rgba(255,255,255,0.05); border:1px solid #333; padding:10px; text-align:center; transition:0.2s; }
.shop-item:hover { border-color:var(--main); background:rgba(0,210,255,0.1); }
.tab-bar { display:flex; width:90%; margin-bottom:10px; }
.tab { flex:1; padding:10px; background:#222; text-align:center; cursor:pointer; border:1px solid #444; }
.tab.active { background:var(--main); color:black; }

/* HUD */
#hud { display:none; width:100%; height:100%; pointer-events:none; }
.bar-cont { width:200px; height:10px; background:#333; margin:5px 0; border:1px solid #555; }
.bar-fill { height:100%; background:lime; width:100%; transition:0.2s; }
#mob-ctrl { display:none; position:absolute; bottom:20px; left:20px; width:120px; height:120px; background:rgba(255,255,255,0.1); border-radius:50%; pointer-events:auto; }
#btn-fire { position:absolute; bottom:30px; right:30px; width:80px; height:80px; background:rgba(255,0,0,0.3); border-radius:50%; display:flex; align-items:center; justify-content:center; pointer-events:auto; font-size:12px; border:2px solid red;}
</style>
</head>
<body>

<!-- GAME CANVAS -->
<canvas id="cvs"></canvas>

<!-- HUD -->
<div id="ui-layer">
    <div id="hud" class="hud-panel" style="background:transparent; border:none; width:auto;">
        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
            <div>
                <div style="font-size:12px; color:#aaa;">HULL INTEGRITY</div>
                <div class="bar-cont"><div id="hud-hp" class="bar-fill"></div></div>
                <div style="font-size:12px; color:#aaa;">WEAPON TEMP</div>
                <div class="bar-cont"><div id="hud-temp" class="bar-fill" style="background:orange; width:0%"></div></div>
            </div>
            <div style="text-align:right;">
                <div id="hud-score" style="font-size:24px; color:gold;">0</div>
                <div id="hud-wave" style="font-size:16px;">WAVE 1</div>
                <!-- AUTO FIRE BUTTON -->
                <button id="btn-auto" onclick="game.toggleAuto()" style="font-size:10px; padding:5px; margin-top:5px; background:lime;">AUTO: ON</button>
            </div>
        </div>
        <div id="boss-hp-cont" style="display:none; position:absolute; top:80px; left:10%; width:80%;">
            <div style="text-align:center; color:red; font-weight:bold;">BOSS WARNING</div>
            <div class="bar-cont" style="width:100%; height:15px; border-color:red;"><div id="boss-hp" class="bar-fill" style="background:red;"></div></div>
        </div>
    </div>
</div>

<!-- LOGIN SCREEN -->
<div id="sc-login" class="screen">
    <h1> BRIGA v8.1</h1>
    <div style="font-size:12px; color:#aaa; margin-bottom:20px;">SECURE PROTOCOL LINK</div>
    <input id="log-u" placeholder="CALLSIGN (Username)">
    <input id="log-p" type="password" placeholder="ACCESS CODE">
    <br>
    <button onclick="auth.login()">ENGAGE ENGINES</button>
    <button onclick="auth.reg()" style="background:transparent; border:1px solid #444; color:#aaa;">NEW RECRUIT</button>
</div>

<!-- LOBBY SCREEN -->
<div id="sc-lobby" class="screen" style="display:none;">
    <div style="display:flex; justify-content:space-between; width:90%; border-bottom:1px solid #333; padding-bottom:10px;">
        <div>
            <div style="font-size:10px; color:#aaa;">PILOT</div>
            <div id="lob-name" style="font-size:20px; color:var(--main);">UNKNOWN</div>
            <div style="font-size:10px; color:lime;">STATUS: ACTIVE</div>
        </div>
        <div style="text-align:right;">
            <div id="lob-cred" style="font-size:20px; color:gold;">0 </div>
            <button onclick="location.reload()" style="font-size:10px; padding:2px 5px; background:#333; color:#fff;">LOGOUT</button>
        </div>
    </div>

    <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; width:100%;">
        <div class="tab-bar">
            <div class="tab active" onclick="ui.tab('ops')">OPS</div>
            <div class="tab" onclick="ui.tab('shop')">SHOP</div>
            <div class="tab" onclick="ui.tab('lb')">TOP</div>
            <div class="tab" onclick="ui.tab('adm')" id="btn-adm-tab" style="display:none; color:red;">ADM</div>
        </div>

        <!-- TAB: OPS -->
        <div id="tab-ops" style="text-align:center;">
            <h3>MISSION</h3>
            <button onclick="game.start('Classic')" style="width:200px; height:60px; font-size:18px;"> SPACE FARM</button><br>
            <button onclick="game.start('Meteor')" style="width:200px; height:60px; font-size:18px; background:purple; color:white;">锔 METEOR STORM</button><br>
            <div style="margin-top:20px; color:#666;">DIFFICULTY</div>
            <select id="diff-sel" style="background:#222; color:white; border:1px solid #444; padding:5px;">
                <option value="1">EASY</option>
                <option value="2">HARD</option>
                <option value="3">INSANE</option>
            </select>
        </div>

        <!-- TAB: SHOP -->
        <div id="tab-shop" style="display:none; width:100%; text-align:center;">
            <div class="tab-bar" style="width:60%; margin:0 auto; font-size:12px;">
                <div class="tab" onclick="shop.filter('upg')">UPGRADES</div>
                <div class="tab" onclick="shop.filter('skin')">AVATARS</div>
            </div>
            <div id="shop-cont" class="shop-grid"></div>
        </div>

        <!-- TAB: LEADERBOARD -->
        <div id="tab-lb" style="display:none; width:90%; overflow:auto;">
            <table style="width:100%; font-size:12px; text-align:left;">
                <tbody id="lb-body"></tbody>
            </table>
        </div>
        
        <!-- TAB: ADMIN -->
        <div id="tab-adm" style="display:none; width:90%; text-align:left;">
            <h3>ACCESS CONSOLE</h3>
            <textarea id="adm-notes" style="width:100%; height:50px; background:#111; color:lime;"></textarea>
            <button onclick="admin.saveNotes()">UPDATE NOTES</button>
        </div>
    </div>
</div>

<!-- GAME OVER -->
<div id="sc-over" class="screen" style="display:none; background:rgba(0,0,0,0.8);">
    <h1 style="color:red; font-size:40px;">MISSION FAILED</h1>
    <div style="font-size:20px;">SCORE</div>
    <div id="go-score" style="font-size:40px; color:white;">0</div>
    <div id="go-cred" style="color:gold;">CREDITS EARNED: 0</div>
    <br>
    <button onclick="app.lobby()">RETURN TO BASE</button>
</div>

<!-- CONTROLS MOBILE -->
<div id="mob-ctrl"><div id="stick-zone" style="width:100%; height:100%;"></div></div>
<div id="btn-fire" onclick="game.manualFire()">FIRE</div>

<script>
/** BRIGAGAME v8.1 REFORGED **/
const API = "https://ubriga.pythonanywhere.com"; // 砖 转转 砖专转 砖  砖
let USER=null, TOKEN=localStorage.getItem('px_t8');
let SHOP_DATA = {};
let ACTIVE_SKIN = localStorage.getItem('px_skin') || 'plane'; // Default skin

const auth={
    login:async()=>{
        try {
            let res = await fetch(API+'/login', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:v('log-u'), password:v('log-p')})});
            let d = await res.json();
            if(d.token) {
                USER=d.user; TOKEN=d.token; localStorage.setItem('px_t8', TOKEN);
                app.lobby();
            } else alert(d.error);
        } catch(e) { alert("Connection Error"); }
    },
    reg:async()=>{
        let res = await fetch(API+'/register', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:v('log-u'), password:v('log-p')})});
        if((await res.json()).status==='success') alert("Registered! Login now."); else alert("Username taken.");
    }
};

const app={
    lobby:async()=>{
        document.querySelectorAll('.screen').forEach(s=>s.style.display='none');
        document.getElementById('sc-lobby').style.display='flex';
        
        document.getElementById('lob-name').innerText = USER.display_name || USER.username;
        document.getElementById('lob-cred').innerText = USER.credits.toLocaleString() + " ";
        
        let res = await fetch(API+'/shop/items');
        SHOP_DATA = await res.json();
        shop.filter('upg'); // Default view
    }
};

const shop={
    filter:(type)=>{
        let inv = JSON.parse(USER.inventory||'{}');
        let html = "";
        
        for(let k in SHOP_DATA) {
            let it = SHOP_DATA[k];
            let isSkin = (it.type === 'skin');
            if(type === 'upg' && isSkin) continue;
            if(type === 'skin' && !isSkin) continue;
            
            let lvl = inv[k]||0;
            let btn = "";
            
            if(isSkin) {
                if(lvl > 0) {
                    btn = (ACTIVE_SKIN === k) ? `<button class="btn-gold">EQUIPPED</button>` : `<button onclick="shop.equip('${k}')">EQUIP</button>`;
                } else {
                    btn = `<button onclick="shop.buy('${k}')" class="btn-gold">${it.cost}</button>`;
                }
            } else {
                btn = lvl>=it.max ? `<div style="color:red">MAX</div>` : `<button onclick="shop.buy('${k}')" class="btn-gold">${it.cost}</button>`;
            }
            
            html += `<div class="shop-item">
                <div style="font-size:30px;">${it.icon}</div>
                <div>${it.name}</div>
                ${!isSkin ? `<div style="color:#aaa; font-size:10px;">Lvl: ${lvl}/${it.max}</div>` : ''}
                <div style="margin-top:5px;">${btn}</div>
            </div>`;
        }
        
        // Add default plane to skins
        if(type==='skin') {
            let defBtn = (ACTIVE_SKIN === 'plane') ? `<button class="btn-gold">EQUIPPED</button>` : `<button onclick="shop.equip('plane')">EQUIP</button>`;
            html = `<div class="shop-item"><div style="font-size:30px;">锔</div><div>Fighter Jet</div><div>${defBtn}</div></div>` + html;
        }
        
        document.getElementById('shop-cont').innerHTML = html;
    },
    buy:async(key)=>{
        let res = await fetch(API+'/shop/buy', {
            method:'POST', headers:{'Content-Type':'application/json', 'Authorization':'Bearer '+TOKEN},
            body:JSON.stringify({item:key})
        });
        let d = await res.json();
        if(d.status==='success') {
            USER.credits = d.credits;
            USER.inventory = JSON.stringify(d.inventory);
            document.getElementById('lob-cred').innerText = USER.credits + " ";
            shop.filter(SHOP_DATA[key].type==='skin'?'skin':'upg');
        } else alert(d.error);
    },
    equip:(key)=>{
        ACTIVE_SKIN = key;
        localStorage.setItem('px_skin', key);
        shop.filter('skin');
    }
};

const game={
    cvs:document.getElementById('cvs'),
    ctx:document.getElementById('cvs').getContext('2d'),
    run:false, paused:false, mode:'Classic', wave:0, score:0,
    objs:[], p:{x:0, y:0, hp:100, maxHp:100, heat:0},
    keys:{},
    autoFire: true,
    
    start:(m)=>{
        game.mode = m;
        document.getElementById('sc-lobby').style.display='none';
        document.getElementById('hud').style.display='block';
        if('ontouchstart' in window) document.getElementById('mob-ctrl').style.display='block';
        
        game.run=true; game.wave=0; game.score=0; game.objs=[];
        game.cvs.width=window.innerWidth; game.cvs.height=window.innerHeight;
        game.p = {x:game.cvs.width/2, y:game.cvs.height-100, hp:100, maxHp:100, heat:0, w:40, h:40};
        
        game.nextWave();
        loop();
    },
    
    nextWave:()=>{
        game.wave++;
        document.getElementById('hud-wave').innerText="WAVE "+game.wave;
        
        let isBoss = (game.wave % 5 === 0);
        
        if(isBoss) {
            // BOSS SPAWN
            game.objs.push({
                type:'boss', x:game.cvs.width/2, y:-100, 
                hp:1000 * game.wave, max:1000 * game.wave, 
                w:80, h:80, vy:2, vx:3, state:'enter'
            });
            document.getElementById('boss-hp-cont').style.display='block';
        } else {
            document.getElementById('boss-hp-cont').style.display='none';
            let count = 3 + game.wave; 
            for(let i=0; i<count; i++) {
                game.objs.push({
                    type:'en', 
                    x:Math.random()*(game.cvs.width-50)+25, 
                    y:-Math.random()*200 - 50, // Start above screen
                    w:40, h:40, 
                    vy: Math.random()*2+1, vx: Math.random() > 0.5 ? 2 : -2,
                    state: 'enter',
                    hp: 20 * game.wave,
                    sprite: ['','',''][Math.floor(Math.random()*3)]
                });
            }
        }
    },
    
    toggleAuto:()=>{
        game.autoFire = !game.autoFire;
        document.getElementById('btn-auto').innerText = "AUTO: " + (game.autoFire ? "ON" : "OFF");
        document.getElementById('btn-auto').style.background = game.autoFire ? "lime" : "orange";
    },
    
    manualFire:()=>{
        if(!game.autoFire) fire();
    }
};

// INPUT HANDLING
let tx=0, ty=0;
window.onkeydown = e => game.keys[e.key] = true;
window.onkeyup = e => game.keys[e.key] = false;

// SMOOTH TOUCH MOVE (No Teleport)
document.addEventListener('touchmove', (e)=>{
    e.preventDefault();
    tx = e.touches[0].clientX;
    // ty = e.touches[0].clientY; // Optional Y movement
}, {passive: false});

document.addEventListener('touchstart', (e)=>{
    tx = e.touches[0].clientX; // Set initial target on touch
});

function fire() {
    if(game.p.heat > 80) return;
    let inv = JSON.parse(USER.inventory||'{}');
    
    // Double Shot
    if(inv.double_shot) {
        game.objs.push({type:'bull', x:game.p.x-10, y:game.p.y-20, w:4, h:10, vy:-10});
        game.objs.push({type:'bull', x:game.p.x+10, y:game.p.y-20, w:4, h:10, vy:-10});
    } else {
        game.objs.push({type:'bull', x:game.p.x, y:game.p.y-20, w:4, h:10, vy:-10});
    }
    game.p.heat += 5;
}

function drawPlayer(ctx, x, y) {
    ctx.save();
    ctx.translate(x, y);
    
    if(ACTIVE_SKIN === 'skin_ufo') {
        // UFO DRAWING
        ctx.fillStyle = "#0f0";
        ctx.beginPath(); ctx.ellipse(0, 5, 25, 10, 0, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "rgba(100,255,100,0.5)";
        ctx.beginPath(); ctx.arc(0, 0, 15, Math.PI, 0); ctx.fill();
    } 
    else if(ACTIVE_SKIN === 'skin_dragon') {
        // DRAGON DRAWING
        ctx.fillStyle = "red";
        ctx.font = "40px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle";
        ctx.fillText("", 0, 0);
    }
    else {
        // DEFAULT PLANE
        ctx.fillStyle = "#00d2ff";
        ctx.beginPath();
        ctx.moveTo(0, -25); ctx.lineTo(-10, 20); ctx.lineTo(0, 15); ctx.lineTo(10, 20);
        ctx.closePath(); ctx.fill();
        
        ctx.fillStyle = "#008cba";
        ctx.beginPath();
        ctx.moveTo(0, -5); ctx.lineTo(-25, 10); ctx.lineTo(-10, 10); ctx.lineTo(10, 10); ctx.lineTo(25, 10);
        ctx.closePath(); ctx.fill();
    }
    ctx.restore();
}

function loop() {
    if(!game.run) return;
    requestAnimationFrame(loop);
    
    let ctx = game.ctx;
    ctx.clearRect(0,0,game.cvs.width,game.cvs.height);
    
    // MOVEMENT SMOOTHING
    if(tx) {
        let dx = tx - game.p.x;
        // Limit speed to prevent teleporting
        let maxSpeed = 15;
        if(Math.abs(dx) > maxSpeed) dx = Math.sign(dx) * maxSpeed;
        game.p.x += dx;
        
        // Reset tx slightly if close to avoid micro-jitters
        if(Math.abs(tx - game.p.x) < 1) tx = 0;
    }
    
    // KEYBOARD MOVE
    if(game.keys['ArrowLeft']) game.p.x -= 5;
    if(game.keys['ArrowRight']) game.p.x += 5;
    
    // AUTO FIRE
    if(game.autoFire && game.frame % 10 === 0) fire();
    
    game.frame = (game.frame||0) + 1;
    if(game.p.heat > 0) game.p.heat -= 0.5;
    document.getElementById('hud-temp').style.width = game.p.heat + "%";

    // DRAW PLAYER
    drawPlayer(ctx, game.p.x, game.p.y);
    
    // GAME LOGIC
    let activeEnemies = 0;
    
    game.objs.forEach((o, i) => {
        if(o.dead) return;
        
        // --- AI LOGIC START ---
        if(o.type === 'boss') {
            activeEnemies++;
            // State Machine for Boss
            if(o.state === 'enter') {
                o.y += o.vy;
                if(o.y > 100) o.state = 'fight';
            } else {
                // Fight Mode: ZigZag
                o.x += o.vx;
                if(o.x > game.cvs.width - o.w/2 || o.x < o.w/2) o.vx *= -1;
                
                // Boss Shoot
                if(Math.random() < 0.05) game.objs.push({type:'ebull', x:o.x, y:o.y+30, w:6, h:15, vy:5});
            }
            
            // Boss HP Bar Update
            let pct = Math.max(0, o.hp/o.max)*100;
            document.getElementById('boss-hp').style.width = pct + "%";
            
            // Draw Boss
            ctx.fillStyle = 'red';
            ctx.fillRect(o.x-o.w/2, o.y-o.h/2, o.w, o.h);
            ctx.fillStyle = 'white'; ctx.fillText("BOSS", o.x-15, o.y);
        
        } else if (o.type === 'en') {
            activeEnemies++;
            // Enemy Mechanics: Stay on screen
            if(o.state === 'enter') {
                o.y += o.vy;
                if(o.y > Math.random()*200 + 50) o.state = 'hover';
            } else {
                // Hover/Bounce Logic
                o.x += o.vx;
                o.y += Math.sin(game.frame/20) * 2; // Bobbing
                if(o.x > game.cvs.width - 20 || o.x < 20) o.vx *= -1;
                
                // Random Shoot
                if(Math.random() < 0.005) game.objs.push({type:'ebull', x:o.x, y:o.y, w:5, h:10, vy:4});
            }
            
            ctx.font = "30px Arial"; ctx.textAlign="center";
            ctx.fillText(o.sprite, o.x, o.y);
            
        } else if(o.type === 'bull') {
            o.y += o.vy;
            ctx.fillStyle = '#0f0'; ctx.fillRect(o.x-2, o.y, 4, 15);
            if(o.y < 0) o.dead = true;
            
            // Collision Player Bullet vs Enemy
            game.objs.forEach(t => {
                if((t.type==='en' || t.type==='boss') && !t.dead && !o.dead) {
                    if(Math.abs(o.x - t.x) < t.w/2 + 10 && Math.abs(o.y - t.y) < t.h/2 + 10) {
                        o.dead = true;
                        t.hp -= (10 + (JSON.parse(USER.inventory||'{}').damage||0)*5);
                        if(t.hp <= 0) {
                            t.dead = true;
                            game.score += (t.type==='boss'?1000:100);
                            document.getElementById('hud-score').innerText = game.score;
                        }
                    }
                }
            });
            
        } else if(o.type === 'ebull') {
            o.y += o.vy;
            ctx.fillStyle = 'red'; ctx.fillRect(o.x-2, o.y, 4, 15);
            if(o.y > game.cvs.height) o.dead = true;
            
            // Hit Player
            if(Math.abs(o.x - game.p.x) < 20 && Math.abs(o.y - game.p.y) < 20) {
                o.dead = true;
                game.p.hp -= 10;
                document.getElementById('hud-hp').style.width = game.p.hp + "%";
                if(game.p.hp <= 0) gameOver();
            }
        }
    });
    
    // Wave Clear Check
    if(activeEnemies === 0 && game.objs.length > 0) {
        // Wait a bit then next wave
        setTimeout(game.nextWave, 1000);
        game.objs = []; // Clear bullets
    }
}

function gameOver() {
    game.run = false;
    document.getElementById('sc-over').style.display='flex';
    document.getElementById('go-score').innerText = game.score;
    let earn = Math.floor(game.score / 10);
    document.getElementById('go-cred').innerText = "CREDITS EARNED: " + earn;
    
    // Update server
    USER.credits += earn;
    fetch(API+'/score/submit', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({
        player: USER.username, score: game.score, wave: game.wave, diff: 'Normal', mode: game.mode
    })});
    
    // Need to sync credits to DB actually (simplified here, ideally server validates score)
}

function v(id){ return document.getElementById(id).value; }
const ui={ tab:(t)=>{ document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active')); event.target.classList.add('active'); document.querySelectorAll('[id^="tab-"]').forEach(e=>e.style.display='none'); document.getElementById('tab-'+t).style.display='block'; }};

window.onload = ()=> { 
    if(TOKEN) auth.login(); 
    app.cvs.width=window.innerWidth; app.cvs.height=window.innerHeight;
};
</script>
</body>
</html>

